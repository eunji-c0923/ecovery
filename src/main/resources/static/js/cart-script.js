// Global variables
let cartItems = [];
let cartTotal = 0;
let appliedCoupons = [];

// DOM Elements
const header = document.getElementById('header');
const hamburger = document.getElementById('hamburger');
const navMenu = document.getElementById('navMenu');
const cartCountElement = document.getElementById('cartCount');
const selectedCountElement = document.getElementById('selectedCount');

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeHeader();
    initializeCart();
    initializeEventListeners();
    updateCartSummary();
    
    console.log('üõí GreenCycle Ïû•Î∞îÍµ¨ÎãàÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
});

// Header functionality
function initializeHeader() {
    // Header scroll effect
    window.addEventListener('scroll', () => {
        if (window.scrollY > 100) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    });
    
    // Mobile menu toggle
    if (hamburger) {
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            
            // Animate hamburger
            const spans = hamburger.querySelectorAll('span');
            if (hamburger.classList.contains('active')) {
                spans[0].style.transform = 'rotate(45deg) translate(5px, 5px)';
                spans[1].style.opacity = '0';
                spans[2].style.transform = 'rotate(-45deg) translate(7px, -6px)';
            } else {
                spans[0].style.transform = 'none';
                spans[1].style.opacity = '1';
                spans[2].style.transform = 'none';
            }
        });
    }
    
    // Close mobile menu when clicking on a link
    document.querySelectorAll('.nav-menu a').forEach(link => {
        link.addEventListener('click', () => {
            closeMobileMenu();
        });
    });
}

function closeMobileMenu() {
    if (hamburger && navMenu) {
        hamburger.classList.remove('active');
        navMenu.classList.remove('active');
        
        const spans = hamburger.querySelectorAll('span');
        spans[0].style.transform = 'none';
        spans[1].style.opacity = '1';
        spans[2].style.transform = 'none';
    }
}

// Initialize cart
async function initializeCart() {
    try {
        // TODO: Î∞±ÏóîÎìúÏóêÏÑú Ïû•Î∞îÍµ¨Îãà Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        // const response = await fetch('/api/cart');
        // cartItems = await response.json();
        
        loadCartFromStorage(); // ÏûÑÏãúÎ°ú Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÏÇ¨Ïö©
        updateCartCount();
        updateSelectedCount();
        
    } catch (error) {
        console.error('Ïû•Î∞îÍµ¨Îãà Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
        loadCartFromStorage(); // Ìè¥Î∞±ÏúºÎ°ú Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÏÇ¨Ïö©
    }
}

// Event listeners
function initializeEventListeners() {
    // Select all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', toggleSelectAll);
    }
    
    // Individual item checkboxes
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    itemCheckboxes.forEach((checkbox, index) => {
        checkbox.addEventListener('change', () => toggleItemSelection(index));
    });
    
    // Quantity inputs
    const quantityInputs = document.querySelectorAll('.qty-input');
    quantityInputs.forEach((input, index) => {
        input.addEventListener('change', (e) => {
            const newQuantity = parseInt(e.target.value);
            if (newQuantity > 0 && newQuantity <= 10) {
                const itemId = parseInt(input.id.split('-')[1]);
                updateItemQuantity(itemId, newQuantity);
            }
        });
    });
}

// Cart functionality
async function updateQuantity(itemId, change) {
    const item = cartItems.find(item => item.id === itemId);
    if (item) {
        const newQuantity = item.quantity + change;
        if (newQuantity > 0 && newQuantity <= 10) {
            try {
                // TODO: Î∞±ÏóîÎìúÏóê ÏàòÎüâ Î≥ÄÍ≤Ω ÏöîÏ≤≠
                // await fetch(`/api/cart/${itemId}`, {
                //     method: 'PUT',
                //     body: JSON.stringify({ quantity: newQuantity })
                // });
                
                item.quantity = newQuantity;
                document.getElementById(`qty-${itemId}`).value = newQuantity;
                updateCartSummary();
                saveCartToStorage(); // ÏûÑÏãú Ï†ÄÏû•
                showNotification(`ÏàòÎüâÏù¥ ${newQuantity}Í∞úÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`, 'info');
                
            } catch (error) {
                console.error('ÏàòÎüâ Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                showNotification('ÏàòÎüâ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }
    }
}

async function updateItemQuantity(itemId, quantity) {
    const item = cartItems.find(item => item.id === itemId);
    if (item) {
        try {
            // TODO: Î∞±ÏóîÎìúÏóê ÏàòÎüâ Î≥ÄÍ≤Ω ÏöîÏ≤≠
            // await fetch(`/api/cart/${itemId}`, {
            //     method: 'PUT',
            //     body: JSON.stringify({ quantity })
            // });
            
            item.quantity = quantity;
            updateCartSummary();
            saveCartToStorage(); // ÏûÑÏãú Ï†ÄÏû•
            showNotification(`ÏàòÎüâÏù¥ ${quantity}Í∞úÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`, 'info');
            
        } catch (error) {
            console.error('ÏàòÎüâ Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
            showNotification('ÏàòÎüâ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll').checked;
    cartItems.forEach(item => {
        item.selected = selectAll;
    });
    
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    itemCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
    });
    
    updateSelectedCount();
    updateCartSummary();
}

function toggleItemSelection(index) {
    const item = cartItems[index];
    if (item) {
        item.selected = !item.selected;
        updateSelectedCount();
        updateCartSummary();
        
        // Update select all checkbox
        const allSelected = cartItems.every(item => item.selected);
        const selectAllCheckbox = document.getElementById('selectAll');
        selectAllCheckbox.checked = allSelected;
    }
}

function updateCartCount() {
    const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
    if (cartCountElement) {
        cartCountElement.textContent = totalItems;
    }
}

function updateSelectedCount() {
    const selectedItems = cartItems.filter(item => item.selected).length;
    if (selectedCountElement) {
        selectedCountElement.textContent = selectedItems;
    }
}

function updateCartSummary() {
    const selectedItems = cartItems.filter(item => item.selected);
    
    // Calculate subtotal
    const subtotal = selectedItems.reduce((sum, item) => {
        return sum + (item.price * item.quantity);
    }, 0);
    
    // Calculate discount
    const originalTotal = selectedItems.reduce((sum, item) => {
        const originalPrice = item.originalPrice || item.price;
        return sum + (originalPrice * item.quantity);
    }, 0);
    
    const discount = originalTotal - subtotal;
    
    // Apply coupon discounts
    let finalTotal = subtotal;
    appliedCoupons.forEach(coupon => {
        if (coupon.type === 'percentage') {
            finalTotal = finalTotal * (1 - coupon.value / 100);
        } else if (coupon.type === 'fixed') {
            finalTotal = Math.max(0, finalTotal - coupon.value);
        }
    });
    
    // Update DOM
    const subtotalElement = document.getElementById('subtotal');
    const discountElement = document.getElementById('discount');
    const totalElement = document.getElementById('total');
    
    if (subtotalElement) subtotalElement.textContent = formatPrice(originalTotal);
    if (discountElement) discountElement.textContent = `-${formatPrice(originalTotal - finalTotal)}`;
    if (totalElement) totalElement.textContent = formatPrice(finalTotal);
    
    // Update order button
    const orderButton = document.querySelector('.btn-order');
    if (orderButton) {
        orderButton.textContent = `üõí Ï£ºÎ¨∏ÌïòÍ∏∞ (${formatPrice(finalTotal)})`;
    }
    
    // Update environmental impact
    updateEnvironmentalImpact(selectedItems);
    
    cartTotal = finalTotal;
}

function updateEnvironmentalImpact(selectedItems) {
    const totalCarbonSaved = selectedItems.reduce((sum, item) => {
        return sum + (item.carbonSaved * item.quantity);
    }, 0);
    
    const plasticSaved = Math.round(totalCarbonSaved * 50); // Estimate plastic saved
    const pointsToEarn = Math.floor(cartTotal * 0.01); // 1% of total as points
    
    // Update impact display
    const carbonElement = document.querySelector('.impact-item:nth-child(1) .impact-value');
    const plasticElement = document.querySelector('.impact-item:nth-child(2) .impact-value');
    const pointsElement = document.querySelector('.impact-item:nth-child(3) .impact-value');
    
    if (carbonElement) carbonElement.textContent = `${totalCarbonSaved.toFixed(1)}kg CO‚ÇÇ`;
    if (plasticElement) plasticElement.textContent = `${plasticSaved}g`;
    if (pointsElement) pointsElement.textContent = `${pointsToEarn}P`;
}

function formatPrice(price) {
    return new Intl.NumberFormat('ko-KR').format(Math.round(price)) + 'Ïõê';
}

// Cart actions
async function removeItem(itemId) {
    const itemIndex = cartItems.findIndex(item => item.id === itemId);
    if (itemIndex !== -1) {
        const itemName = cartItems[itemIndex].name;
        
        try {
            // TODO: Î∞±ÏóîÎìúÏóêÏÑú ÏÉÅÌíà Ï†úÍ±∞
            // await fetch(`/api/cart/${itemId}`, { method: 'DELETE' });
            
            cartItems.splice(itemIndex, 1);
            
            // Remove from DOM
            const cartItemElement = document.querySelector(`[data-item-id="${itemId}"]`);
            if (cartItemElement) {
                cartItemElement.style.opacity = '0';
                cartItemElement.style.transform = 'translateX(-100px)';
                setTimeout(() => {
                    cartItemElement.remove();
                    updateCartCount();
                    updateSelectedCount();
                    updateCartSummary();
                }, 300);
            }
            
            saveCartToStorage(); // ÏûÑÏãú Ï†ÄÏû•
            showNotification(`"${itemName}"Ïù¥ Ïû•Î∞îÍµ¨ÎãàÏóêÏÑú Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§.`, 'success');
            
        } catch (error) {
            console.error('ÏÉÅÌíà Ï†úÍ±∞ Ïò§Î•ò:', error);
            showNotification('ÏÉÅÌíà Ï†úÍ±∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

async function deleteSelected() {
    const selectedItems = cartItems.filter(item => item.selected);
    if (selectedItems.length === 0) {
        showNotification('ÏÑ†ÌÉùÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.', 'warning');
        return;
    }
    
    if (confirm(`ÏÑ†ÌÉùÌïú ${selectedItems.length}Í∞ú ÏÉÅÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        try {
            // TODO: Î∞±ÏóîÎìúÏóêÏÑú ÏÑ†ÌÉùÎêú ÏÉÅÌíàÎì§ ÏÇ≠Ï†ú
            // const itemIds = selectedItems.map(item => item.id);
            // await fetch('/api/cart/batch-delete', {
            //     method: 'DELETE',
            //     body: JSON.stringify({ itemIds })
            // });
            
            selectedItems.forEach(item => {
                removeItem(item.id);
            });
            showNotification(`${selectedItems.length}Í∞ú ÏÉÅÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`, 'success');
            
        } catch (error) {
            console.error('ÏÑ†ÌÉù ÏÉÅÌíà ÏÇ≠Ï†ú Ïò§Î•ò:', error);
            showNotification('ÏÉÅÌíà ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

async function addToWishlist(itemId) {
    const item = cartItems.find(item => item.id === itemId);
    if (item) {
        try {
            // TODO: Î∞±ÏóîÎìúÏóê Í¥ÄÏã¨ÏÉÅÌíà Ï∂îÍ∞Ä
            // await fetch('/api/wishlist', {
            //     method: 'POST',
            //     body: JSON.stringify({ productId: itemId })
            // });
            
            showNotification(`"${item.name}"Ïù¥ Í¥ÄÏã¨ÏÉÅÌíàÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§. üíñ`, 'success');
            
            // Animate heart
            const heartBtn = event.target;
            heartBtn.style.transform = 'scale(1.3)';
            heartBtn.style.color = '#dc3545';
            setTimeout(() => {
                heartBtn.style.transform = 'scale(1)';
            }, 200);
            
        } catch (error) {
            console.error('Í¥ÄÏã¨ÏÉÅÌíà Ï∂îÍ∞Ä Ïò§Î•ò:', error);
            showNotification('Í¥ÄÏã¨ÏÉÅÌíà Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

async function moveAllToWishlist() {
    const selectedItems = cartItems.filter(item => item.selected);
    if (selectedItems.length === 0) {
        showNotification('ÏÑ†ÌÉùÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.', 'warning');
        return;
    }
    
    if (confirm(`ÏÑ†ÌÉùÌïú ${selectedItems.length}Í∞ú ÏÉÅÌíàÏùÑ Í¥ÄÏã¨ÏÉÅÌíàÏúºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        try {
            // TODO: Î∞±ÏóîÎìúÏóêÏÑú Í¥ÄÏã¨ÏÉÅÌíàÏúºÎ°ú Ïù¥Îèô
            // const itemIds = selectedItems.map(item => item.id);
            // await fetch('/api/cart/move-to-wishlist', {
            //     method: 'POST',
            //     body: JSON.stringify({ itemIds })
            // });
            
            selectedItems.forEach(item => {
                removeItem(item.id);
            });
            showNotification(`${selectedItems.length}Í∞ú ÏÉÅÌíàÏù¥ Í¥ÄÏã¨ÏÉÅÌíàÏúºÎ°ú Ïù¥ÎèôÎêòÏóàÏäµÎãàÎã§. üíñ`, 'success');
            
        } catch (error) {
            console.error('Í¥ÄÏã¨ÏÉÅÌíà Ïù¥Îèô Ïò§Î•ò:', error);
            showNotification('Í¥ÄÏã¨ÏÉÅÌíà Ïù¥Îèô Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

// Coupon functionality
async function applyCoupon() {
    const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
    
    if (!couponCode) {
        showNotification('Ïø†Ìè∞ ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
        return;
    }
    
    try {
        // TODO: Î∞±ÏóîÎìúÏóêÏÑú Ïø†Ìè∞ Í≤ÄÏ¶ù Î∞è Ï†ÅÏö©
        // const response = await fetch('/api/coupons/apply', {
        //     method: 'POST',
        //     body: JSON.stringify({ code: couponCode })
        // });
        // const coupon = await response.json();
        
        // ÏûÑÏãú Ïø†Ìè∞ Îç∞Ïù¥ÌÑ∞
        const coupons = {
            'FIRST10': { type: 'percentage', value: 10, name: 'Ï≤´ Íµ¨Îß§ 10% Ìï†Ïù∏' },
            'ECO20': { type: 'percentage', value: 20, name: 'ÏπúÌôòÍ≤Ω 20% Ìï†Ïù∏' },
            'WELCOME5000': { type: 'fixed', value: 5000, name: 'Ïã†Í∑úÌöåÏõê 5Ï≤úÏõê Ìï†Ïù∏' }
        };
        
        const coupon = coupons[couponCode];
        if (!coupon) {
            showNotification('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïø†Ìè∞ ÏΩîÎìúÏûÖÎãàÎã§.', 'error');
            return;
        }
        
        // Check if already applied
        if (appliedCoupons.find(c => c.code === couponCode)) {
            showNotification('Ïù¥ÎØ∏ Ï†ÅÏö©Îêú Ïø†Ìè∞ÏûÖÎãàÎã§.', 'warning');
            return;
        }
        
        appliedCoupons.push({ ...coupon, code: couponCode });
        updateCartSummary();
        showNotification(`"${coupon.name}" Ïø†Ìè∞Ïù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§! üé´`, 'success');
        
        // Clear input
        document.getElementById('couponCode').value = '';
        
    } catch (error) {
        console.error('Ïø†Ìè∞ Ï†ÅÏö© Ïò§Î•ò:', error);
        showNotification('Ïø†Ìè∞ Ï†ÅÏö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
    }
}

function applyCouponDirect(couponCode) {
    document.getElementById('couponCode').value = couponCode;
    applyCoupon();
}

// Navigation functions
function goToMarket() {
    showNotification('ÏóêÏΩîÎßàÏºìÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§. üõçÔ∏è', 'info');
    console.log('ÏóêÏΩîÎßàÏºìÏúºÎ°ú Ïù¥Îèô');
    // TODO: Ïã§Ï†ú ÌéòÏù¥ÏßÄ Ïù¥Îèô
    // window.location.href = 'eco-market.html';
}

async function proceedToOrder() {
    const selectedItems = cartItems.filter(item => item.selected);
    if (selectedItems.length === 0) {
        showNotification('Ï£ºÎ¨∏Ìï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
        return;
    }
    
    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
    
    // Animate order button
    const orderBtn = event.target;
    orderBtn.textContent = 'Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë...';
    orderBtn.disabled = true;
    orderBtn.style.opacity = '0.7';
    
    try {
        // TODO: Î∞±ÏóîÎìúÏóê Ï£ºÎ¨∏ ÏÉùÏÑ± ÏöîÏ≤≠
        // const orderData = {
        //     items: selectedItems,
        //     paymentMethod: paymentMethod,
        //     total: cartTotal
        // };
        // await fetch('/api/orders', {
        //     method: 'POST',
        //     body: JSON.stringify(orderData)
        // });
        
        setTimeout(() => {
            showNotification(`${selectedItems.length}Í∞ú ÏÉÅÌíà Ï£ºÎ¨∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! üéâ`, 'success');
            console.log('Ï£ºÎ¨∏ ÏôÑÎ£å:', { items: selectedItems, payment: paymentMethod, total: cartTotal });
            
            // Reset button
            orderBtn.textContent = `üõí Ï£ºÎ¨∏ÌïòÍ∏∞ (${formatPrice(cartTotal)})`;
            orderBtn.disabled = false;
            orderBtn.style.opacity = '1';
            
            // TODO: Í≤∞Ï†ú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            // window.location.href = 'checkout.html';
        }, 2000);
        
    } catch (error) {
        console.error('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ïò§Î•ò:', error);
        showNotification('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        
        // Reset button
        orderBtn.textContent = `üõí Ï£ºÎ¨∏ÌïòÍ∏∞ (${formatPrice(cartTotal)})`;
        orderBtn.disabled = false;
        orderBtn.style.opacity = '1';
    }
}

// Recommended products
async function addRecommendedToCart(productId) {
    try {
        // TODO: Î∞±ÏóîÎìúÏóêÏÑú Ï∂îÏ≤ú ÏÉÅÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        // const response = await fetch(`/api/products/${productId}`);
        // const product = await response.json();
        
        // ÏûÑÏãú Ï∂îÏ≤ú ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞
        const products = {
            1: { name: 'Ï≤úÏó∞ Ïú†Í∏∞ÎÜç ÏÉ¥Ìë∏', price: 18000 },
            2: { name: 'Ï≤úÏó∞ Ïò¨Î¶¨Î∏å ÎπÑÎàÑ ÏÑ∏Ìä∏', price: 12500 },
            3: { name: 'ÎåÄÎÇòÎ¨¥ ÌôîÏû•ÏßÄ 12Î°§', price: 24000 },
            4: { name: 'Î∞ÄÏßö ÏãùÍ∏∞ ÏÑ∏Ìä∏', price: 35000 }
        };
        
        const product = products[productId];
        if (product) {
            // TODO: Î∞±ÏóîÎìúÏóê Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä ÏöîÏ≤≠
            // await fetch('/api/cart', {
            //     method: 'POST',
            //     body: JSON.stringify({ productId })
            // });
            
            showNotification(`"${product.name}"Ïù¥ Ïû•Î∞îÍµ¨ÎãàÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§! üõí`, 'success');
            
            // Animate product card
            const productCard = event.target.closest('.product-card');
            productCard.style.transform = 'scale(0.95)';
            productCard.style.boxShadow = '0 0 20px rgba(45, 90, 61, 0.3)';
            
            setTimeout(() => {
                productCard.style.transform = 'scale(1)';
                productCard.style.boxShadow = '';
            }, 200);
            
            // Update cart count
            updateCartCount();
        }
        
    } catch (error) {
        console.error('Ï∂îÏ≤ú ÏÉÅÌíà Ï∂îÍ∞Ä Ïò§Î•ò:', error);
        showNotification('ÏÉÅÌíà Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
    }
}

// Notification system
function showNotification(message, type = 'success') {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${getNotificationColor(type)};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
        font-weight: 500;
        font-size: 14px;
    `;
    
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Hide notification
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function getNotificationColor(type) {
    switch(type) {
        case 'success': return '#2d5a3d';
        case 'error': return '#dc3545';
        case 'warning': return '#ffc107';
        case 'info': return '#6fa776';
        default: return '#2d5a3d';
    }
}

// Animations and interactions
function animateCartUpdate() {
    const cartItems = document.querySelectorAll('.cart-item');
    cartItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
            item.style.transition = 'all 0.3s ease';
        }, index * 100);
    });
}

// Local storage management (ÏûÑÏãú ÏÇ¨Ïö©)
function saveCartToStorage() {
    try {
        localStorage.setItem('greenCycleCart', JSON.stringify(cartItems));
        localStorage.setItem('greenCycleCoupons', JSON.stringify(appliedCoupons));
    } catch (error) {
        console.error('Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error);
    }
}

function loadCartFromStorage() {
    try {
        const savedCart = localStorage.getItem('greenCycleCart');
        const savedCoupons = localStorage.getItem('greenCycleCoupons');
        
        if (savedCart) {
            cartItems = JSON.parse(savedCart);
        }
        
        if (savedCoupons) {
            appliedCoupons = JSON.parse(savedCoupons);
        }
    } catch (error) {
        console.error('Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Î°úÎìú Ïò§Î•ò:', error);
        cartItems = [];
        appliedCoupons = [];
    }
}

// Page lifecycle events
window.addEventListener('beforeunload', () => {
    saveCartToStorage();
});

// Performance optimization
function optimizeImages() {
    const images = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                imageObserver.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}

// Error handling
function handleError(error, context = '') {
    console.error(`Error in ${context}:`, error);
    showNotification('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
}

// Accessibility enhancements
function enhanceAccessibility() {
    // Add ARIA labels
    const quantityButtons = document.querySelectorAll('.qty-btn');
    quantityButtons.forEach(btn => {
        const isPlus = btn.textContent === '+';
        btn.setAttribute('aria-label', isPlus ? 'ÏàòÎüâ Ï¶ùÍ∞Ä' : 'ÏàòÎüâ Í∞êÏÜå');
    });
    
    // Add keyboard support for product cards
    const productCards = document.querySelectorAll('.product-card');
    productCards.forEach(card => {
        card.setAttribute('tabindex', '0');
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                card.click();
            }
        });
    });
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    try {
        loadCartFromStorage();
        initializeHeader();
        initializeCart();
        initializeEventListeners();
        updateCartSummary();
        optimizeImages();
        enhanceAccessibility();
        
        // Animate cart items on load
        setTimeout(() => {
            animateCartUpdate();
        }, 500);
        
        console.log('üõí GreenCycle Ïû•Î∞îÍµ¨Îãà Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        
    } catch (error) {
        handleError(error, 'Cart initialization');
    }
});

// Global error handler
window.addEventListener('error', (e) => {
    handleError(e.error, 'Global error');
});

// Expose functions globally for HTML onclick events
window.updateQuantity = updateQuantity;
window.removeItem = removeItem;
window.deleteSelected = deleteSelected;
window.addToWishlist = addToWishlist;
window.moveAllToWishlist = moveAllToWishlist;
window.applyCoupon = applyCoupon;
window.applyCouponDirect = applyCouponDirect;
window.goToMarket = goToMarket;
window.proceedToOrder = proceedToOrder;
window.addRecommendedToCart = addRecommendedToCart;