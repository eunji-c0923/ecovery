<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - GreenCycle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- 타임리프 CSS 링크 처리 -->
    <link rel="stylesheet" th:href="@{/css/auth.css}">
</head>
<body>
    <div class="auth-container">
        <!-- Background Elements -->
        <div class="bg-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>

        <!-- Header -->
        <header class="auth-header">
            <a th:href="@{/}" class="logo">
                <img th:src="@{/img/logo2.png}" alt="GreenCycle 로고" class="logo-img">
            </a>
            <a th:href="@{/}" class="back-link">← 홈으로 돌아가기</a>
        </header>

        <!-- Main Content -->
        <main class="auth-main">
            <div class="auth-card">
                <div class="auth-header-content">
                    <h1>회원가입</h1>
                    <p>지속가능한 미래를 위한 첫 걸음을 내디뎌보세요</p>
                </div>

                <!-- 회원가입 폼 - 타임리프 객체 바인딩 -->
                <form class="auth-form" id="signupForm" 
                      th:action="@{/signup}" 
                      th:object="${signupForm}" 
                      method="post">
                    
                    <!-- 이메일 입력 필드 -->
                    <div class="form-group">
                        <label for="email">이메일</label>
                        <div class="input-wrapper">
                            <span class="input-icon">📧</span>
                            <input 
                                type="email" 
                                id="email" 
                                th:field="*{email}"
                                placeholder="이메일을 입력하세요"
                                required
                                autocomplete="email"
                                th:class="${#fields.hasErrors('email')} ? 'error' : ''"
                            >
                            <button type="button" class="input-action" id="checkEmail">중복확인</button>
                        </div>
                        <!-- 타임리프 에러 메시지 표시 -->
                        <span class="error-message" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></span>
                        <span class="success-message" id="emailSuccess" style="display: none;">사용 가능한 이메일입니다.</span>
                    </div>

                    <!-- 닉네임 입력 필드 -->
                    <div class="form-group">
                        <label for="nickname">닉네임</label>
                        <div class="input-wrapper">
                            <span class="input-icon">👤</span>
                            <input 
                                type="text" 
                                id="nickname" 
                                th:field="*{nickname}"
                                placeholder="닉네임을 입력하세요 (2-20자)"
                                required
                                maxlength="20"
                                autocomplete="username"
                                th:class="${#fields.hasErrors('nickname')} ? 'error' : ''"
                            >
                            <button type="button" class="input-action" id="checkNickname">중복확인</button>
                        </div>
                        <!-- 타임리프 에러 메시지 표시 -->
                        <span class="error-message" th:if="${#fields.hasErrors('nickname')}" th:errors="*{nickname}"></span>
                        <span class="success-message" id="nicknameSuccess" style="display: none;">사용 가능한 닉네임입니다.</span>
                    </div>

                    <!-- 비밀번호 입력 필드 -->
                    <div class="form-group">
                        <label for="password">비밀번호</label>
                        <div class="input-wrapper">
                            <span class="input-icon">🔒</span>
                            <input 
                                type="password" 
                                id="password" 
                                th:field="*{password}"
                                placeholder="비밀번호를 입력하세요 (8자 이상)"
                                required
                                minlength="8"
                                autocomplete="new-password"
                                th:class="${#fields.hasErrors('password')} ? 'error' : ''"
                            >
                            <button type="button" class="toggle-password" id="togglePassword">
                                <span class="eye-icon">👁️</span>
                            </button>
                        </div>
                        <div class="password-strength" id="passwordStrength">
                            <div class="strength-bar">
                                <div class="strength-fill"></div>
                            </div>
                            <span class="strength-text">비밀번호 강도</span>
                        </div>
                        <!-- 타임리프 에러 메시지 표시 -->
                        <span class="error-message" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></span>
                    </div>

                    <!-- 비밀번호 확인 입력 필드 -->
                    <div class="form-group">
                        <label for="passwordConfirm">비밀번호 확인</label>
                        <div class="input-wrapper">
                            <span class="input-icon">🔒</span>
                            <input 
                                type="password" 
                                id="passwordConfirm" 
                                th:field="*{passwordConfirm}"
                                placeholder="비밀번호를 다시 입력하세요"
                                required
                                autocomplete="new-password"
                                th:class="${#fields.hasErrors('passwordConfirm')} ? 'error' : ''"
                            >
                            <button type="button" class="toggle-password" id="togglePasswordConfirm">
                                <span class="eye-icon">👁️</span>
                            </button>
                        </div>
                        <!-- 타임리프 에러 메시지 표시 -->
                        <span class="error-message" th:if="${#fields.hasErrors('passwordConfirm')}" th:errors="*{passwordConfirm}"></span>
                        <span class="success-message" id="passwordConfirmSuccess" style="display: none;">비밀번호가 일치합니다.</span>
                    </div>

                    <!-- 지역 선택 - 서버에서 지역 데이터 제공 -->
                    <div class="form-group">
                        <label for="region">지역 선택</label>
                        <div class="input-wrapper">
                            <span class="input-icon">📍</span>
                            <select id="region" th:field="*{region}" required>
                                <option value="">지역을 선택하세요</option>
                                <!-- 타임리프 반복문으로 지역 옵션 생성 -->
                                <option th:each="region : ${regions}" 
                                        th:value="${region.code}" 
                                        th:text="${region.name}">
                                </option>
                            </select>
                        </div>
                        <!-- 타임리프 에러 메시지 표시 -->
                        <span class="error-message" th:if="${#fields.hasErrors('region')}" th:errors="*{region}"></span>
                    </div>

                    <!-- 약관 동의 섹션 -->
                    <div class="agreement-section">
                        <h3>약관 동의</h3>
                        
                        <!-- 전체 동의 체크박스 -->
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="agreeAll" id="agreeAll">
                            <span class="checkmark"></span>
                            <span class="checkbox-text strong">전체 동의</span>
                        </label>

                        <div class="agreement-details">
                            <!-- 필수 약관들 -->
                            <label class="checkbox-wrapper">
                                <input type="checkbox" th:field="*{agreeTerms}" id="agreeTerms" required>
                                <span class="checkmark"></span>
                                <span class="checkbox-text">
                                    (필수) <a th:href="@{/terms}" class="terms-link" target="_blank">이용약관</a>에 동의합니다
                                </span>
                            </label>

                            <label class="checkbox-wrapper">
                                <input type="checkbox" th:field="*{agreePrivacy}" id="agreePrivacy" required>
                                <span class="checkmark"></span>
                                <span class="checkbox-text">
                                    (필수) <a th:href="@{/privacy}" class="terms-link" target="_blank">개인정보처리방침</a>에 동의합니다
                                </span>
                            </label>

                            <label class="checkbox-wrapper">
                                <input type="checkbox" th:field="*{agreeAge}" id="agreeAge" required>
                                <span class="checkmark"></span>
                                <span class="checkbox-text">
                                    (필수) 만 14세 이상입니다
                                </span>
                            </label>

                            <!-- 선택 약관 -->
                            <label class="checkbox-wrapper">
                                <input type="checkbox" th:field="*{agreeMarketing}" id="agreeMarketing">
                                <span class="checkmark"></span>
                                <span class="checkbox-text">
                                    (선택) 마케팅 정보 수신에 동의합니다
                                </span>
                            </label>
                        </div>
                        
                        <!-- 약관 동의 에러 메시지 -->
                        <div th:if="${#fields.hasErrors('agreeTerms') or #fields.hasErrors('agreePrivacy') or #fields.hasErrors('agreeAge')}" 
                             class="error-message">
                            필수 약관에 동의해주세요.
                        </div>
                    </div>

                    <!-- 회원가입 버튼 -->
                    <button type="submit" class="auth-btn primary" id="signupBtn">
                        <span class="btn-text">회원가입</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner"></span>
                            가입 중...
                        </span>
                    </button>

                    <!-- CSRF 토큰 (Spring Security 사용 시) -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <!-- 구분선 -->
                    <div class="divider">
                        <span>또는</span>
                    </div>

                    <!-- 소셜 로그인 - OAuth2 연동 -->
                    <div class="social-login">
                        <a th:href="@{/oauth2/authorization/google}" class="social-btn google">
                            <span class="social-icon">🌐</span>
                            Google로 가입
                        </a>
                        <a th:href="@{/oauth2/authorization/kakao}" class="social-btn kakao">
                            <span class="social-icon">💬</span>
                            카카오로 가입
                        </a>
                    </div>
                </form>

                <!-- 로그인 링크 -->
                <div class="auth-footer">
                    <p>이미 계정이 있으신가요? <a th:href="@{/login}" class="auth-link">로그인</a></p>
                </div>
            </div>
        </main>
    </div>

    <!-- 에러/성공 메시지 표시 영역 -->
    <div th:if="${message}" class="alert-container">
        <div th:class="'alert ' + ${messageType}" th:text="${message}">
            <!-- 서버에서 전달된 메시지 표시 -->
        </div>
    </div>

    <!-- 이메일 중복 확인 모달 -->
    <div class="modal-overlay" id="emailCheckModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>이메일 중복 확인</h3>
                <button class="modal-close" onclick="closeEmailCheckModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="emailCheckMessage"></p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="closeEmailCheckModal()">확인</button>
            </div>
        </div>
    </div>

    <!-- 닉네임 중복 확인 모달 -->
    <div class="modal-overlay" id="nicknameCheckModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>닉네임 중복 확인</h3>
                <button class="modal-close" onclick="closeNicknameCheckModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="nicknameCheckMessage"></p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="closeNicknameCheckModal()">확인</button>
            </div>
        </div>
    </div>

    <!-- JavaScript 파일 연결 - 타임리프 URL 처리 -->
    <script th:src="@{/js/auth.js}"></script>
    
    <!-- 타임리프 인라인 스크립트 - 서버 데이터 전달 -->
    <script th:inline="javascript">
        // 서버에서 전달받은 데이터를 JavaScript 변수로 설정
        var regions = /*[[${regions}]]*/ [];
        var csrfToken = /*[[${_csrf.token}]]*/ '';
        var csrfHeader = /*[[${_csrf.headerName}]]*/ '';
        
        // 중복 확인 API URL 설정
        var emailCheckUrl = /*[[@{/api/users/check-email}]]*/ '/api/users/check-email';
        var nicknameCheckUrl = /*[[@{/api/users/check-nickname}]]*/ '/api/users/check-nickname';
        
        // 폼 검증 메시지 설정
        var validationMessages = {
            email: {
                required: '이메일을 입력해주세요.',
                invalid: '올바른 이메일 형식을 입력해주세요.',
                duplicate: '이미 사용 중인 이메일입니다.',
                available: '사용 가능한 이메일입니다.'
            },
            nickname: {
                required: '닉네임을 입력해주세요.',
                length: '닉네임은 2~20자로 입력해주세요.',
                duplicate: '이미 사용 중인 닉네임입니다.',
                available: '사용 가능한 닉네임입니다.'
            },
            password: {
                required: '비밀번호를 입력해주세요.',
                length: '비밀번호는 8자 이상 입력해주세요.',
                weak: '비밀번호가 너무 간단합니다.',
                medium: '보통 강도의 비밀번호입니다.',
                strong: '강력한 비밀번호입니다.'
            },
            passwordConfirm: {
                required: '비밀번호 확인을 입력해주세요.',
                mismatch: '비밀번호가 일치하지 않습니다.',
                match: '비밀번호가 일치합니다.'
            }
        };
    </script>
</body>
</html>