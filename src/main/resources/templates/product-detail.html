<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title th:text="${product.title + ' - ìƒí’ˆ ìƒì„¸ë³´ê¸° - GreenCycle'}">ìƒí’ˆ ìƒì„¸ë³´ê¸° - GreenCycle</title>
    
    <!-- SEO ë©”íƒ€ íƒœê·¸ -->
    <meta name="description" th:content="${product.description}">
    <meta name="keywords" th:content="${product.tags}">
    <meta property="og:title" th:content="${product.title}">
    <meta property="og:description" th:content="${product.description}">
    <meta property="og:image" th:content="@{'/api/images/' + ${product.mainImageId}}">
    <meta property="og:url" th:content="@{'/eco-market/products/' + ${product.id}}">
    
    <!-- êµ¬ê¸€ í°íŠ¸ ë§í¬ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- íƒ€ì„ë¦¬í”„ CSS íŒŒì¼ ë§í¬ -->
    <link rel="stylesheet" th:href="@{/css/product-detail.css}">
</head>
<body>
    <!-- í—¤ë” ì„¹ì…˜ - ìƒë‹¨ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ -->
    <header class="header" id="header">
        <nav class="navbar">
            <div class="nav-container">
                <!-- ë¡œê³  ì˜ì—­ -->
                <a th:href="@{/}" class="logo">
                    <span class="logo-icon">ğŸŒ±</span>
                    <span class="logo-text">GreenCycle</span>
                </a>
                
                <!-- ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
                <ul class="nav-menu" id="navMenu">
                    <li><a th:href="@{/}">í™ˆ</a></li>
                    <li><a th:href="@{/services}">ì„œë¹„ìŠ¤</a></li>
                    <li><a th:href="@{/waste-sorting}">ë¶„ë¦¬ë°°ì¶œ</a></li>
                    <li><a th:href="@{/free-sharing}">ë¬´ë£Œë‚˜ëˆ”</a></li>
                    <li><a th:href="@{/eco-market}" class="active">ì—ì½”ë§ˆì¼“</a></li>
                    <li><a th:href="@{/eco-talk}">í™˜ê²½ë…í†¡</a></li>
                    <li><a th:href="@{/notices}">ê³µì§€ì‚¬í•­</a></li>
                </ul>
                
                <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ë˜ëŠ” ì‚¬ìš©ì ë©”ë‰´ -->
                <div class="auth-buttons" id="authButtons">
                    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° -->
                    <div class="guest-buttons" id="guestButtons" th:if="${session.user == null}">
                        <a th:href="@{/login}" class="btn-login">ë¡œê·¸ì¸</a>
                        <a th:href="@{/signup}" class="btn-signup">íšŒì›ê°€ì…</a>
                    </div>
                    
                    <!-- ë¡œê·¸ì¸í•œ ê²½ìš° -->
                    <div class="user-menu" id="userMenu" th:if="${session.user != null}">
                        <span class="user-name" id="userName" th:text="${session.user.nickname + 'ë‹˜'}">ì‚¬ìš©ìë‹˜</span>
                        <a th:href="@{/mypage}" class="btn-mypage">ë§ˆì´í˜ì´ì§€</a>
                        <button class="btn-logout" id="logoutBtn" th:onclick="|location.href='@{/logout}'|">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
                
                <!-- ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´ -->
                <div class="hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <main class="main-content">
        <!-- ë¸Œë ˆë“œí¬ëŸ¼ ë„¤ë¹„ê²Œì´ì…˜ -->
        <section class="breadcrumb-section">
            <div class="container">
                <nav class="breadcrumb">
                    <a th:href="@{/}">í™ˆ</a>
                    <span class="breadcrumb-separator">></span>
                    <a th:href="@{/eco-market}">ì—ì½”ë§ˆì¼“</a>
                    <span class="breadcrumb-separator">></span>
                    <span id="breadcrumbCategory" th:text="${product.category.name}">ì¹´í…Œê³ ë¦¬</span>
                    <span class="breadcrumb-separator">></span>
                    <span class="breadcrumb-current">ìƒí’ˆ ìƒì„¸ë³´ê¸°</span>
                </nav>
            </div>
        </section>

        <!-- ìƒí’ˆ ìƒì„¸ ì •ë³´ ì„¹ì…˜ -->
        <section class="product-detail-section">
            <div class="container">
                <div class="product-detail-container">
                    <!-- ì™¼ìª½: ìƒí’ˆ ì´ë¯¸ì§€ ì˜ì—­ -->
                    <div class="product-images">
                        <!-- ë©”ì¸ ì´ë¯¸ì§€ -->
                        <div class="main-image-container">
                            <div class="main-image" id="mainImage">
                                <img th:src="@{'/api/images/' + ${product.mainImageId}}" 
                                     th:alt="${product.title}"
                                     onerror="this.innerHTML='ğŸ’»'">
                            </div>
                            <!-- ì´ë¯¸ì§€ í™•ëŒ€ ë²„íŠ¼ -->
                            <button class="image-zoom-btn" id="imageZoomBtn" onclick="openImageModal()">ğŸ”</button>
                        </div>
                        
                        <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ ëª©ë¡ -->
                        <div class="thumbnail-container" th:if="${product.images.size() > 1}">
                            <div class="thumbnail-list" id="thumbnailList">
                                <div th:each="image, imageStat : ${product.images}" 
                                     th:class="${imageStat.first} ? 'thumbnail active' : 'thumbnail'"
                                     th:data-image="${image.id}"
                                     th:onclick="|changeMainImage('${image.id}')|">
                                    <img th:src="@{'/api/images/' + ${image.id}}" 
                                         th:alt="'ìƒí’ˆ ì´ë¯¸ì§€ ' + ${imageStat.count}"
                                         onerror="this.innerHTML='ğŸ“·'">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì •ë³´ ì˜ì—­ -->
                    <div class="product-info">
                        <!-- ìƒí’ˆ ê¸°ë³¸ ì •ë³´ -->
                        <div class="product-header">
                            <!-- ìƒí’ˆ ìƒíƒœ ë±ƒì§€ -->
                            <div class="product-status-badge" 
                                 th:class="'product-status-badge ' + ${product.status.cssClass}"
                                 id="productStatus"
                                 th:text="${product.status.displayName}">íŒë§¤ì¤‘</div>
                            
                            <h1 class="product-title" id="productTitle" th:text="${product.title}">ìƒí’ˆëª…</h1>
                            
                            <!-- ìƒí’ˆ ë©”ë‰´ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³  ë³¸ì¸ ìƒí’ˆì¼ ë•Œë§Œ í‘œì‹œ) -->
                            <div class="product-menu" id="productMenu" 
                                 th:if="${session.user != null && session.user.id == product.seller.id}">
                                <button class="menu-toggle" id="menuToggle">â‹¯</button>
                                <div class="menu-dropdown" id="menuDropdown">
                                    <button class="menu-item" th:onclick="|editProduct(${product.id})|">ìˆ˜ì •í•˜ê¸°</button>
                                    <button class="menu-item delete" th:onclick="|deleteProduct(${product.id})|">ì‚­ì œí•˜ê¸°</button>
                                </div>
                            </div>
                            
                            <!-- ìƒí’ˆ ë©”íƒ€ ì •ë³´ -->
                            <div class="product-meta">
                                <span class="product-category" id="productCategory" th:text="${product.category.name}">ì¹´í…Œê³ ë¦¬</span>
                                <span class="product-views">ğŸ‘ï¸ <span id="productViews" th:text="${product.viewCount}">ì¡°íšŒìˆ˜</span></span>
                                <span class="product-time" id="productTime" 
                                      th:text="${product.timeAgo}">ê²Œì‹œì‹œê°„</span>
                            </div>
                        </div>

                        <!-- ê°€ê²© ì •ë³´ -->
                        <div class="price-section">
                            <div class="current-price" id="currentPrice" 
                                 th:text="${#numbers.formatInteger(product.currentPrice, 3)} + 'ì›'">í˜„ì¬ê°€ê²©</div>
                            <div class="original-price" id="originalPrice" 
                                 th:if="${product.originalPrice > product.currentPrice}"
                                 th:text="${#numbers.formatInteger(product.originalPrice, 3)} + 'ì›'">ì›ë˜ê°€ê²©</div>
                            <div class="discount-rate" id="discountRate" 
                                 th:if="${product.discountRate > 0}"
                                 th:text="${product.discountRate} + '% í• ì¸'">í• ì¸ë¥ </div>
                        </div>

                        <!-- ìƒí’ˆ ìƒíƒœ ì •ë³´ -->
                        <div class="condition-section">
                            <h3>ìƒí’ˆ ìƒíƒœ</h3>
                            <div class="condition-info">
                                <div class="condition-rating">
                                    <span class="condition-stars" id="conditionStars" 
                                          th:text="${product.condition.stars}">â˜…â˜…â˜…â˜…â˜…</span>
                                    <span class="condition-text" id="conditionText" 
                                          th:text="${product.condition.displayName}">ìƒíƒœ</span>
                                </div>
                                <p class="condition-description" th:text="${product.conditionDescription}">
                                    ìƒí’ˆ ìƒíƒœ ì„¤ëª…
                                </p>
                            </div>
                        </div>

                        <!-- ê±°ë˜ ì •ë³´ -->
                        <div class="transaction-section">
                            <div class="transaction-info">
                                <div class="info-item">
                                    <span class="info-label">ê±°ë˜ ì§€ì—­</span>
                                    <span class="info-value" id="transactionLocation" 
                                          th:text="'ğŸ“ ' + ${product.location}">ê±°ë˜ì§€ì—­</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ê±°ë˜ ë°©ë²•</span>
                                    <span class="info-value" th:text="${product.transactionMethod}">ê±°ë˜ë°©ë²•</span>
                                </div>
                                <div class="info-item" th:if="${product.deliveryFee >= 0}">
                                    <span class="info-label">ë°°ì†¡ë¹„</span>
                                    <span class="info-value" 
                                          th:text="${product.deliveryFee == 0 ? 'ë¬´ë£Œ' : 'ì°©ë¶ˆ (' + #numbers.formatInteger(product.deliveryFee, 3) + 'ì›)'}">ë°°ì†¡ë¹„</span>
                                </div>
                            </div>
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ - ë¡œê·¸ì¸ ìƒíƒœì™€ ë³¸ì¸ ìƒí’ˆ ì—¬ë¶€ì— ë”°ë¥¸ ì¡°ê±´ë¶€ ë Œë”ë§ -->
                        <div class="action-buttons">
                            <!-- ê´€ì‹¬ìƒí’ˆ ë²„íŠ¼ - ë³¸ì¸ ìƒí’ˆì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í‘œì‹œ -->
                            <button class="btn btn-wishlist" id="wishlistBtn" 
                                    th:if="${session.user == null || session.user.id != product.seller.id}"
                                    th:onclick="|toggleWishlist(${product.id})|"
                                    th:class="${product.isWishListed} ? 'btn btn-wishlist active' : 'btn btn-wishlist'">
                                <span class="heart-icon" th:text="${product.isWishListed} ? 'â¤ï¸' : 'ğŸ¤'">ğŸ¤</span>
                                ê´€ì‹¬ìƒí’ˆ <span id="wishlistCount" th:text="${product.wishlistCount}">0</span>
                            </button>
                            
                            <!-- ì±„íŒ…í•˜ê¸° ë²„íŠ¼ - ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³  ë³¸ì¸ ìƒí’ˆì´ ì•„ë‹Œ ê²½ìš° -->
                            <button class="btn btn-chat" id="chatBtn" 
                                    th:if="${session.user != null && session.user.id != product.seller.id}"
                                    th:onclick="|startChat(${product.seller.id})|">ğŸ’¬ ì±„íŒ…í•˜ê¸°</button>
                            
                            <!-- êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ - ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³  ë³¸ì¸ ìƒí’ˆì´ ì•„ë‹Œ ê²½ìš° -->
                            <button class="btn btn-buy" id="buyBtn" 
                                    th:if="${session.user != null && session.user.id != product.seller.id && product.status.name() == 'AVAILABLE'}"
                                    th:onclick="|buyProduct(${product.id})|">ğŸ’° êµ¬ë§¤í•˜ê¸°</button>
                            
                            <!-- ë¡œê·¸ì¸ ìœ ë„ ë²„íŠ¼ - ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì -->
                            <button class="btn btn-login-required" 
                                    th:if="${session.user == null}"
                                    th:onclick="|location.href='@{/login}'|">ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”</button>
                            
                            <!-- ë³¸ì¸ ìƒí’ˆì¸ ê²½ìš° -->
                            <div class="owner-actions" th:if="${session.user != null && session.user.id == product.seller.id}">
                                <button class="btn btn-edit" th:onclick="|editProduct(${product.id})|">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
                                <button class="btn btn-delete" th:onclick="|deleteProduct(${product.id})|">ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</button>
                            </div>
                        </div>

                        <!-- ê³µìœ  ë²„íŠ¼ -->
                        <div class="share-section">
                            <span class="share-label">ê³µìœ í•˜ê¸°</span>
                            <div class="share-buttons">
                                <button class="share-btn" data-type="link" title="ë§í¬ ë³µì‚¬" 
                                        th:onclick="|shareProduct('link', '${product.id}')|">ğŸ”—</button>
                                <button class="share-btn" data-type="kakao" title="ì¹´ì¹´ì˜¤í†¡" 
                                        th:onclick="|shareProduct('kakao', '${product.id}')|">ğŸ’¬</button>
                                <button class="share-btn" data-type="facebook" title="í˜ì´ìŠ¤ë¶" 
                                        th:onclick="|shareProduct('facebook', '${product.id}')|">ğŸ“˜</button>
                                <button class="share-btn" data-type="twitter" title="íŠ¸ìœ„í„°" 
                                        th:onclick="|shareProduct('twitter', '${product.id}')|">ğŸ¦</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ìƒí’ˆ ìƒì„¸ ì„¤ëª… ì„¹ì…˜ -->
        <section class="product-description-section">
            <div class="container">
                <div class="description-container">
                    <h2>ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h2>
                    <div class="description-content" id="productDescription">
                        <!-- íƒ€ì„ë¦¬í”„ë¡œ HTML ë‚´ìš© ë Œë”ë§ (utext ì‚¬ìš©) -->
                        <div th:utext="${product.description}">ìƒí’ˆ ì„¤ëª… ë‚´ìš©</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- íŒë§¤ì ì •ë³´ ì„¹ì…˜ -->
        <section class="seller-section">
            <div class="container">
                <div class="seller-container">
                    <h2>íŒë§¤ì ì •ë³´</h2>
                    <div class="seller-info">
                        <div class="seller-profile">
                            <div class="seller-avatar">
                                <img th:if="${product.seller.profileImageId != null}" 
                                     th:src="@{'/api/images/' + ${product.seller.profileImageId}}" 
                                     th:alt="${product.seller.nickname}">
                                <span th:if="${product.seller.profileImageId == null}">ğŸ‘¤</span>
                            </div>
                            <div class="seller-details">
                                <h3 class="seller-name" id="sellerName" th:text="${product.seller.nickname + 'ë‹˜'}">íŒë§¤ìë‹˜</h3>
                                <div class="seller-rating">
                                    <span class="rating-stars" th:text="${product.seller.ratingStars}">â­â­â­â­â­</span>
                                    <span class="rating-score" id="sellerRating" 
                                          th:text="${#numbers.formatDecimal(product.seller.rating, 1, 1)} + '/5.0'">í‰ì </span>
                                    <span class="rating-count" 
                                          th:text="'(' + ${product.seller.reviewCount} + 'ê±´)'">í›„ê¸°ìˆ˜</span>
                                </div>
                                <div class="seller-badges">
                                    <!-- íŒë§¤ì ë±ƒì§€ë“¤ - ì¡°ê±´ë¶€ ë Œë”ë§ -->
                                    <span class="badge badge-verified" th:if="${product.seller.isVerified}">ì¸ì¦ëœ íŒë§¤ì</span>
                                    <span class="badge badge-response" th:if="${product.seller.isQuickResponse}">ë¹ ë¥¸ ì‘ë‹µ</span>
                                    <span class="badge badge-eco" th:if="${product.seller.isEcoSeller}">ì¹œí™˜ê²½ ì…€ëŸ¬</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- íŒë§¤ì í†µê³„ -->
                        <div class="seller-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="sellerSales" th:text="${product.seller.salesCount}">íŒë§¤ìˆ˜</div>
                                <div class="stat-label">íŒë§¤ì™„ë£Œ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" th:text="${product.seller.satisfactionRate} + '%'">ë§Œì¡±ë„</div>
                                <div class="stat-label">ë§Œì¡±ë„</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" th:text="${product.seller.avgResponseTime}">ì‘ë‹µì‹œê°„</div>
                                <div class="stat-label">í‰ê· ì‘ë‹µ</div>
                            </div>
                        </div>
                        
                        <!-- íŒë§¤ì ì•¡ì…˜ ë²„íŠ¼ -->
                        <div class="seller-actions">
                            <button class="btn btn-secondary" id="sellerProfileBtn" 
                                    th:onclick="|viewSellerProfile(${product.seller.id})|">í”„ë¡œí•„ ë³´ê¸°</button>
                            <button class="btn btn-primary" id="sellerChatBtn" 
                                    th:if="${session.user != null && session.user.id != product.seller.id}"
                                    th:onclick="|startChat(${product.seller.id})|">ì±„íŒ…í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <section class="comments-section">
            <div class="container">
                <div class="comments-container">
                    <!-- ëŒ“ê¸€ í—¤ë” -->
                    <div class="comments-header">
                        <h2>ìƒí’ˆ ë¬¸ì˜</h2>
                        <span class="comments-count">ì´ <span id="commentsCount" th:text="${comments.size()}">0</span>ê°œì˜ ëŒ“ê¸€</span>
                    </div>

                    <!-- ëŒ“ê¸€ ì‘ì„± í¼ - ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ -->
                    <div class="comment-form-container" th:if="${session.user != null}">
                        <form class="comment-form" id="commentForm" 
                              th:action="@{'/api/products/' + ${product.id} + '/comments'}" 
                              method="post">
                            <div class="comment-input-group">
                                <div class="commenter-info">
                                    <div class="commenter-avatar">
                                        <img th:if="${session.user.profileImageId != null}" 
                                             th:src="@{'/api/images/' + ${session.user.profileImageId}}" 
                                             th:alt="${session.user.nickname}">
                                        <span th:if="${session.user.profileImageId == null}">ğŸ‘¤</span>
                                    </div>
                                    <span class="commenter-name" th:text="${session.user.nickname}">ë‹‰ë„¤ì„</span>
                                </div>
                                <div class="comment-input-container">
                                    <textarea 
                                        class="comment-input" 
                                        name="content"
                                        id="commentInput" 
                                        placeholder="ìƒí’ˆì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”..."
                                        rows="3"
                                        required></textarea>
                                    <div class="comment-form-actions">
                                        <div class="comment-guidelines">
                                            <small>â€¢ ìƒí’ˆê³¼ ê´€ë ¨ì—†ëŠ” ë‚´ìš©ì€ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
                                            <small>â€¢ ìš•ì„¤, ë¹„ë°©, ê´‘ê³ ì„± ëŒ“ê¸€ì€ ê¸ˆì§€ë©ë‹ˆë‹¤</small>
                                        </div>
                                        <button type="submit" class="btn btn-comment">ëŒ“ê¸€ ì‘ì„±</button>
                                    </div>
                                </div>
                            </div>
                            <!-- CSRF í† í° -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        </form>
                    </div>

                    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²Œ ë¡œê·¸ì¸ ìœ ë„ -->
                    <div class="comment-login-prompt" th:if="${session.user == null}">
                        <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a th:href="@{/login}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- ëŒ“ê¸€ ì •ë ¬ ì˜µì…˜ -->
                    <div class="comments-sort" th:if="${!#lists.isEmpty(comments)}">
                        <select id="commentSort" onchange="sortComments()">
                            <option value="latest">ìµœì‹ ìˆœ</option>
                            <option value="oldest">ë“±ë¡ìˆœ</option>
                            <option value="likes">ì¶”ì²œìˆœ</option>
                        </select>
                    </div>

                    <!-- ëŒ“ê¸€ ëª©ë¡ -->
                    <div class="comments-list" id="commentsList">
                        <!-- íƒ€ì„ë¦¬í”„ ë°˜ë³µë¬¸ìœ¼ë¡œ ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§ -->
                        <div th:each="comment : ${comments}" class="comment-item" th:data-comment-id="${comment.id}">
                            <div class="comment-avatar">
                                <img th:if="${comment.author.profileImageId != null}" 
                                     th:src="@{'/api/images/' + ${comment.author.profileImageId}}" 
                                     th:alt="${comment.author.nickname}">
                                <span th:if="${comment.author.profileImageId == null}">ğŸ‘¤</span>
                            </div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author" th:text="${comment.author.nickname}">ì‘ì„±ì</span>
                                    <!-- íŒë§¤ìì¸ ê²½ìš° ë±ƒì§€ í‘œì‹œ -->
                                    <span class="seller-badge" th:if="${comment.author.id == product.seller.id}">íŒë§¤ì</span>
                                    <span class="comment-date" th:text="${comment.timeAgo}">ì‘ì„±ì‹œê°„</span>
                                    
                                    <!-- ëŒ“ê¸€ ì•¡ì…˜ ë©”ë‰´ -->
                                    <div class="comment-actions">
                                        <!-- ë³¸ì¸ ëŒ“ê¸€ì¸ ê²½ìš° -->
                                        <div th:if="${session.user != null && session.user.id == comment.author.id}" class="owner-actions">
                                            <button class="comment-edit-btn" th:onclick="|editComment(${comment.id})|">ìˆ˜ì •</button>
                                            <button class="comment-delete-btn" th:onclick="|deleteComment(${comment.id})|">ì‚­ì œ</button>
                                        </div>
                                        <!-- ë‹¤ë¥¸ ì‚¬ìš©ì ëŒ“ê¸€ì¸ ê²½ìš° -->
                                        <div th:if="${session.user != null && session.user.id != comment.author.id}" class="other-actions">
                                            <button class="comment-report-btn" th:onclick="|reportComment(${comment.id})|">ì‹ ê³ </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-text" th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</div>
                                <div class="comment-footer">
                                    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                                    <button class="comment-like-btn" 
                                            th:if="${session.user != null}"
                                            th:onclick="|toggleCommentLike(${comment.id})|"
                                            th:class="${comment.isLiked} ? 'comment-like-btn active' : 'comment-like-btn'">
                                        <span th:text="${comment.isLiked} ? 'ğŸ‘' : 'ğŸ‘'">ğŸ‘</span>
                                        <span th:text="${comment.likeCount}">ì¢‹ì•„ìš” ìˆ˜</span>
                                    </button>
                                    <!-- ë‹µê¸€ ë²„íŠ¼ -->
                                    <button class="comment-reply-btn" 
                                            th:if="${session.user != null}"
                                            th:onclick="|replyToComment(${comment.id})|">ë‹µê¸€</button>
                                </div>
                                
                                <!-- ë‹µê¸€ ëª©ë¡ -->
                                <div class="replies" th:if="${!#lists.isEmpty(comment.replies)}">
                                    <div th:each="reply : ${comment.replies}" class="reply-item">
                                        <div class="reply-avatar">
                                            <img th:if="${reply.author.profileImageId != null}" 
                                                 th:src="@{'/api/images/' + ${reply.author.profileImageId}}" 
                                                 th:alt="${reply.author.nickname}">
                                            <span th:if="${reply.author.profileImageId == null}">ğŸ‘¤</span>
                                        </div>
                                        <div class="reply-content">
                                            <div class="reply-header">
                                                <span class="reply-author" th:text="${reply.author.nickname}">ë‹µê¸€ ì‘ì„±ì</span>
                                                <span class="seller-badge" th:if="${reply.author.id == product.seller.id}">íŒë§¤ì</span>
                                                <span class="reply-date" th:text="${reply.timeAgo}">ë‹µê¸€ ì‹œê°„</span>
                                            </div>
                                            <div class="reply-text" th:text="${reply.content}">ë‹µê¸€ ë‚´ìš©</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš° -->
                        <div th:if="${#lists.isEmpty(comments)}" class="no-comments">
                            <div class="no-comments-icon">ğŸ’¬</div>
                            <h3>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p th:if="${session.user != null}">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                            <p th:if="${session.user == null}">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a th:href="@{/login}">ë¡œê·¸ì¸</a>í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>

                    <!-- ëŒ“ê¸€ ë”ë³´ê¸° ë²„íŠ¼ -->
                    <div class="comments-load-more" th:if="${hasMoreComments}">
                        <button class="btn btn-secondary" id="loadMoreComments" 
                                th:onclick="|loadMoreComments(${product.id})|">ëŒ“ê¸€ ë”ë³´ê¸°</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ì—°ê´€ ìƒí’ˆ ì„¹ì…˜ -->
        <section class="related-products-section" th:if="${!#lists.isEmpty(relatedProducts)}">
            <div class="container">
                <h2>ì´ëŸ° ìƒí’ˆì€ ì–´ë– ì„¸ìš”?</h2>
                <div class="related-products-grid" id="relatedProductsGrid">
                    <!-- íƒ€ì„ë¦¬í”„ ë°˜ë³µë¬¸ìœ¼ë¡œ ì—°ê´€ ìƒí’ˆ ë Œë”ë§ -->
                    <div th:each="relatedProduct : ${relatedProducts}" class="related-product-item">
                        <a th:href="@{'/eco-market/products/' + ${relatedProduct.id}}" class="product-link">
                            <div class="product-image">
                                <img th:src="@{'/api/images/' + ${relatedProduct.mainImageId}}" 
                                     th:alt="${relatedProduct.title}"
                                     onerror="this.innerHTML='ğŸ“¦'">
                            </div>
                            <div class="product-info">
                                <h3 class="product-title" th:text="${relatedProduct.title}">ìƒí’ˆëª…</h3>
                                <div class="product-price" th:text="${#numbers.formatInteger(relatedProduct.currentPrice, 3)} + 'ì›'">ê°€ê²©</div>
                                <div class="product-meta">
                                    <span class="product-location" th:text="${relatedProduct.location}">ì§€ì—­</span>
                                    <span class="product-time" th:text="${relatedProduct.timeAgo}">ì‹œê°„</span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
    <div class="modal" id="imageModal" style="display: none;">
        <div class="modal-content image-modal-content">
            <div class="modal-header">
                <h3>ìƒí’ˆ ì´ë¯¸ì§€</h3>
                <button class="modal-close" id="closeImageModal" onclick="closeImageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-image-container">
                    <div class="modal-main-image" id="modalMainImage">
                        <img th:src="@{'/api/images/' + ${product.mainImageId}}" 
                             th:alt="${product.title}">
                    </div>
                    <div class="modal-image-controls" th:if="${product.images.size() > 1}">
                        <button class="image-nav-btn" id="prevImageBtn" onclick="prevImage()">â€¹</button>
                        <span class="image-counter" id="imageCounter">1 / <span th:text="${product.images.size()}">1</span></span>
                        <button class="image-nav-btn" id="nextImageBtn" onclick="nextImage()">â€º</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëŒ“ê¸€ ì‹ ê³  ëª¨ë‹¬ -->
    <div class="modal" id="reportModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ëŒ“ê¸€ ì‹ ê³ </h3>
                <button class="modal-close" id="closeReportModal" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reportForm" th:action="@{/api/comments/report}" method="post">
                    <div class="form-group">
                        <label>ì‹ ê³  ì‚¬ìœ </label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="reportReason" value="spam" required>
                                <span>ìŠ¤íŒ¸/ê´‘ê³ </span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="reportReason" value="abuse" required>
                                <span>ìš•ì„¤/ë¹„ë°©</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="reportReason" value="inappropriate" required>
                                <span>ë¶€ì ì ˆí•œ ë‚´ìš©</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="reportReason" value="other" required>
                                <span>ê¸°íƒ€</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ìƒì„¸ ë‚´ìš© (ì„ íƒ)</label>
                        <textarea name="description" placeholder="ì‹ ê³  ì‚¬ìœ ë¥¼ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”..." rows="3"></textarea>
                    </div>
                    <input type="hidden" name="commentId" id="reportCommentId">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelReport" onclick="closeReportModal()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-danger">ì‹ ê³ í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ì•¡ì…˜ ë°” (ëª¨ë°”ì¼ìš©) -->
    <div class="bottom-action-bar" id="bottomActionBar">
        <!-- ê´€ì‹¬ìƒí’ˆ ë²„íŠ¼ -->
        <button class="bottom-btn btn-wishlist-mobile" id="wishlistBtnMobile" 
                th:if="${session.user == null || session.user.id != product.seller.id}"
                th:onclick="|toggleWishlist(${product.id})|"
                th:class="${product.isWishListed} ? 'bottom-btn btn-wishlist-mobile active' : 'bottom-btn btn-wishlist-mobile'">
            <span class="heart-icon" th:text="${product.isWishListed} ? 'â¤ï¸' : 'ğŸ¤'">ğŸ¤</span>
        </button>
        
        <!-- ì±„íŒ…í•˜ê¸° ë²„íŠ¼ -->
        <button class="bottom-btn btn-chat-mobile" id="chatBtnMobile" 
                th:if="${session.user != null && session.user.id != product.seller.id}"
                th:onclick="|startChat(${product.seller.id})|">ğŸ’¬ ì±„íŒ…í•˜ê¸°</button>
        
        <!-- êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ -->
        <button class="bottom-btn btn-buy-mobile" id="buyBtnMobile" 
                th:if="${session.user != null && session.user.id != product.seller.id && product.status.name() == 'AVAILABLE'}"
                th:onclick="|buyProduct(${product.id})|">ğŸ’° êµ¬ë§¤í•˜ê¸°</button>
        
        <!-- ë¡œê·¸ì¸ ìœ ë„ ë²„íŠ¼ -->
        <button class="bottom-btn btn-login-mobile" 
                th:if="${session.user == null}"
                th:onclick="|location.href='@{/login}'|">ë¡œê·¸ì¸ í•„ìš”</button>
    </div>

    <!-- í‘¸í„° -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <!-- íšŒì‚¬ ì •ë³´ -->
                <div class="footer-section">
                    <div class="logo" style="margin-bottom: 20px;">
                        <span class="logo-icon">ğŸŒ±</span>
                        <span class="logo-text">GreenCycle</span>
                    </div>
                    <p>ì²¨ë‹¨ ê¸°ìˆ ë¡œ ì‹¤í˜„í•˜ëŠ” ìŠ¤ë§ˆíŠ¸í•˜ê³  ì§€ì† ê°€ëŠ¥í•œ í™˜ê²½ í”Œë«í¼</p>
                </div>
                
                <!-- ì„œë¹„ìŠ¤ ë§í¬ -->
                <div class="footer-section">
                    <h4>ì„œë¹„ìŠ¤</h4>
                    <ul>
                        <li><a th:href="@{/waste-sorting}">ìŠ¤ë§ˆíŠ¸ ë¶„ë¦¬ë°°ì¶œ</a></li>
                        <li><a th:href="@{/free-sharing}">ë¬´ë£Œë‚˜ëˆ”</a></li>
                        <li><a th:href="@{/eco-market}">ì—ì½”ë§ˆì¼“</a></li>
                        <li><a th:href="@{/eco-talk}">í™˜ê²½ë…í†¡</a></li>
                    </ul>
                </div>
                
                <!-- íšŒì‚¬ì •ë³´ ë§í¬ -->
                <div class="footer-section">
                    <h4>íšŒì‚¬ì •ë³´</h4>
                    <ul>
                        <li><a href="#">íšŒì‚¬ì†Œê°œ</a></li>
                        <li><a href="#">ê¸°ìˆ  íŠ¹í—ˆ</a></li>
                        <li><a href="#">ì—°êµ¬ê°œë°œ</a></li>
                        <li><a href="#">ì±„ìš©ì •ë³´</a></li>
                    </ul>
                </div>
                
                <!-- ê³ ê°ì§€ì› ë§í¬ -->
                <div class="footer-section">
                    <h4>ê³ ê°ì§€ì›</h4>
                    <ul>
                        <li><a href="#">ë¬¸ì˜í•˜ê¸°</a></li>
                        <li><a href="#">ì´ìš©ê°€ì´ë“œ</a></li>
                        <li><a href="#">ê¸°ìˆ ì§€ì›</a></li>
                        <li><a href="#">ê³ ê°ì„¼í„°</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- í‘¸í„° í•˜ë‹¨ -->
            <div class="footer-bottom">
                <p>&copy; 2025 GreenCycle. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                    <a href="#">ì´ìš©ì•½ê´€</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript íŒŒì¼ ì—°ê²° -->
    <script th:src="@{/js/product-detail.js}"></script>
    
    <!-- íƒ€ì„ë¦¬í”„ ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript">
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì„¤ì •
        var product = /*[[${product}]]*/ {};
        var comments = /*[[${comments}]]*/ [];
        var relatedProducts = /*[[${relatedProducts}]]*/ [];
        var user = /*[[${session.user}]]*/ null;
        var csrfToken = /*[[${_csrf.token}]]*/ '';
        var csrfHeader = /*[[${_csrf.headerName}]]*/ '';
        
        // API URL ì„¤ì •
        var wishlistToggleUrl = /*[[@{/api/products/{id}/wishlist}]]*/ '/api/products/{id}/wishlist';
        var commentSubmitUrl = /*[[@{/api/products/{id}/comments}]]*/ '/api/products/{id}/comments';
        var commentLikeUrl = /*[[@{/api/comments/{id}/like}]]*/ '/api/comments/{id}/like';
        var commentEditUrl = /*[[@{/api/comments/{id}}]]*/ '/api/comments/{id}';
        var commentDeleteUrl = /*[[@{/api/comments/{id}}]]*/ '/api/comments/{id}';
        var commentReportUrl = /*[[@{/api/comments/{id}/report}]]*/ '/api/comments/{id}/report';
        var chatStartUrl = /*[[@{/api/chats/start}]]*/ '/api/chats/start';
        var buyProductUrl = /*[[@{/eco-market/products/{id}/buy}]]*/ '/eco-market/products/{id}/buy';
        var editProductUrl = /*[[@{/eco-market/products/{id}/edit}]]*/ '/eco-market/products/{id}/edit';
        var deleteProductUrl = /*[[@{/api/products/{id}}]]*/ '/api/products/{id}';
        var sellerProfileUrl = /*[[@{/users/{id}/profile}]]*/ '/users/{id}/profile';
        var shareProductUrl = /*[[@{/api/products/{id}/share}]]*/ '/api/products/{id}/share';
        
        // ì´ë¯¸ì§€ ì„¤ì •
        var currentImageIndex = 0;
        var productImages = /*[[${product.images}]]*/ [];
        
        // ëŒ“ê¸€ ì„¤ì •
        var commentsPerPage = /*[[${commentsPerPage}]]*/ 10;
        var currentCommentPage = /*[[${currentCommentPage}]]*/ 0;
        var hasMoreComments = /*[[${hasMoreComments}]]*/ false;
        var commentSortBy = /*[[${commentSortBy}]]*/ 'latest';
        
        // ê´€ì‹¬ìƒí’ˆ ìƒíƒœ
        var isWishListed = /*[[${product.isWishListed}]]*/ false;
        var wishlistCount = /*[[${product.wishlistCount}]]*/ 0;
        
        // ìƒí’ˆ ìƒíƒœ
        var ProductStatus = {
            AVAILABLE: 'AVAILABLE',
            SOLD: 'SOLD',
            RESERVED: 'RESERVED',
            DELETED: 'DELETED'
        };
        
        // ê³µìœ  ì„¤ì •
        var shareConfig = {
            url: /*[[@{'/eco-market/products/' + ${product.id}}]]*/ '',
            title: /*[[${product.title}]]*/ '',
            description: /*[[${product.description}]]*/ '',
            image: /*[[@{'/api/images/' + ${product.mainImageId}}]]*/ ''
        };
        
        // ë©”ì‹œì§€ ì„¤ì •
        var messages = {
            wishlistAdded: 'ê´€ì‹¬ìƒí’ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
            wishlistRemoved: 'ê´€ì‹¬ìƒí’ˆì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.',
            commentSubmitted: 'ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
            commentLiked: 'ëŒ“ê¸€ì„ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤.',
            commentUnliked: 'ëŒ“ê¸€ ì¶”ì²œì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.',
            commentReported: 'ëŒ“ê¸€ì´ ì‹ ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.',
            linkCopied: 'ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.',
            loginRequired: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
            deleteConfirm: 'ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            chatStarted: 'ì±„íŒ…ì„ ì‹œì‘í•©ë‹ˆë‹¤.',
            purchaseConfirm: 'ì´ ìƒí’ˆì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
        };
    </script>
</body>
</html>