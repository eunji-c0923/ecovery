<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>GreenCycle - 주문/결제</title>
    <!-- Thymeleaf 정적 리소스 경로 사용 -->
    <link rel="stylesheet" th:href="@{/css/checkout.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header - 장바구니와 동일한 헤더 -->
    <header class="header" id="header">
        <nav class="navbar">
            <div class="nav-container">
                <!-- 로고 - Thymeleaf URL 경로 처리 -->
                <a th:href="@{/}" class="logo">
                    <img th:src="@{/img/logo.png}" alt="GreenCycle 로고" class="logo-img">
                </a>
                <ul class="nav-menu" id="navMenu">
                    <li><a th:href="@{/#home}">홈</a></li>
                    <li><a th:href="@{/#services}">서비스</a></li>
                    <li><a th:href="@{/waste-sorting}">분리배출</a></li>
                    <li><a th:href="@{/free-sharing}">무료나눔</a></li>
                    <li><a th:href="@{/eco-market}" class="active">에코마켓</a></li>
                    <li><a th:href="@{/eco-talk}">환경독톡</a></li>
                    <li><a th:href="@{/notices}">공지사항</a></li>
                </ul>
                <div class="auth-buttons">
                    <!-- 장바구니 아이템 개수 동적 표시 -->
                    <a th:href="@{/cart}" class="cart-link">
                        <span class="cart-icon">🛒</span>
                        <span class="cart-count" id="cartCount" th:text="${cartItemCount}">3</span>
                    </a>
                    <!-- 로그인 상태에 따른 조건부 표시 -->
                    <a th:href="@{/mypage}" class="btn-login" th:if="${session.user}">마이페이지</a>
                    <a th:href="@{/login}" class="btn-login" th:unless="${session.user}">로그인</a>
                    <a th:href="@{/logout}" class="btn-logout" th:if="${session.user}">로그아웃</a>
                </div>
                <div class="hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main id="mainContent">
        <!-- 결제 페이지 헤더 섹션 -->
        <section class="checkout-header">
            <div class="container">
                <!-- 페이지 경로 표시 -->
                <div class="breadcrumb">
                    <a th:href="@{/}">홈</a>
                    <span>></span>
                    <a th:href="@{/eco-market}">에코마켓</a>
                    <span>></span>
                    <a th:href="@{/cart}">장바구니</a>
                    <span>></span>
                    <span class="current">주문/결제</span>
                </div>
                <h1>💳 주문/결제</h1>
                <p class="checkout-subtitle">안전하고 빠른 친환경 주문 결제</p>
            </div>
        </section>

        <!-- 결제 진행 단계 표시 -->
        <section class="checkout-steps">
            <div class="container">
                <div class="steps-container">
                    <!-- 1단계: 장바구니 (완료됨) -->
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <div class="step-text">장바구니</div>
                    </div>
                    <div class="step-line completed"></div>
                    
                    <!-- 2단계: 주문/결제 (현재 진행중) -->
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div class="step-text">주문/결제</div>
                    </div>
                    <div class="step-line"></div>
                    
                    <!-- 3단계: 주문완료 (대기중) -->
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-text">주문완료</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 결제 메인 콘텐츠 -->
        <section class="checkout-content">
            <div class="container">
                <!-- 주문/결제 폼 - Thymeleaf 폼 객체 바인딩 -->
                <form th:action="@{/checkout/process}" th:object="${orderForm}" method="post" id="checkoutForm">
                    <div class="checkout-layout">
                        <!-- 왼쪽: 주문 정보 입력 폼 -->
                        <div class="checkout-form">
                            
                            <!-- 배송 정보 입력 섹션 -->
                            <div class="form-section">
                                <h3>🚚 배송 정보</h3>
                                
                                <!-- 받는사람 이름과 연락처 -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="receiverName">받는 분 이름 *</label>
                                        <!-- 기본값으로 로그인한 사용자 이름 사용 -->
                                        <input type="text" th:field="*{receiverName}" id="receiverName" required 
                                               th:value="${session.user != null ? session.user.name : ''}"
                                               placeholder="받는 분 성명을 입력해주세요">
                                        <!-- Thymeleaf 유효성 검사 오류 메시지 -->
                                        <div class="error-message" th:if="${#fields.hasErrors('receiverName')}" th:errors="*{receiverName}"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="receiverPhone">연락처 *</label>
                                        <input type="tel" th:field="*{receiverPhone}" id="receiverPhone" required 
                                               th:value="${session.user != null ? session.user.phone : ''}"
                                               placeholder="010-0000-0000">
                                        <div class="error-message" th:if="${#fields.hasErrors('receiverPhone')}" th:errors="*{receiverPhone}"></div>
                                    </div>
                                </div>
                                
                                <!-- 배송 주소 입력 -->
                                <div class="form-group">
                                    <label for="deliveryAddress">배송 주소 *</label>
                                    <div class="address-input">
                                        <input type="text" th:field="*{zipcode}" id="zipcode" placeholder="우편번호" readonly>
                                        <button type="button" class="btn-search-address" onclick="searchAddress()">
                                            주소 검색
                                        </button>
                                    </div>
                                    <input type="text" th:field="*{address1}" id="address1" placeholder="기본 주소" readonly>
                                    <input type="text" th:field="*{address2}" id="address2" placeholder="상세 주소를 입력해주세요">
                                    <div class="error-message" th:if="${#fields.hasErrors('address1')}" th:errors="*{address1}"></div>
                                </div>
                                
                                <!-- 배송 메시지 선택 -->
                                <div class="form-group">
                                    <label for="deliveryMessage">배송 메시지</label>
                                    <select th:field="*{deliveryMessage}" id="deliveryMessage" onchange="handleDeliveryMessageChange()">
                                        <option value="">배송 메시지를 선택해주세요</option>
                                        <option value="door">문 앞에 놓아주세요</option>
                                        <option value="guard">경비실에 맡겨주세요</option>
                                        <option value="call">배송 전 연락 바랍니다</option>
                                        <option value="custom">직접 입력</option>
                                    </select>
                                    <!-- 직접 입력 시 나타나는 텍스트에리어 -->
                                    <textarea th:field="*{customMessage}" id="customMessage" 
                                             placeholder="요청사항을 입력해주세요" style="display: none;"></textarea>
                                </div>
                            </div>

                            <!-- 결제 정보 입력 섹션 -->
                            <div class="form-section">
                                <h3>💳 결제 정보</h3>
                                
                                <!-- 결제 수단 선택 옵션들 -->
                                <div class="payment-methods">
                                    <!-- 신용카드 결제 옵션 -->
                                    <div class="payment-option">
                                        <input type="radio" th:field="*{paymentMethod}" value="CARD" id="card" onchange="handlePaymentMethodChange('card')">
                                        <label for="card" class="payment-label">
                                            <span class="payment-icon">💳</span>
                                            <div class="payment-info">
                                                <span class="payment-title">신용카드</span>
                                                <span class="payment-desc">즉시 결제</span>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!-- 무통장입금 옵션 (기본 선택됨) -->
                                    <div class="payment-option">
                                        <input type="radio" th:field="*{paymentMethod}" value="BANK" id="bank" checked onchange="handlePaymentMethodChange('bank')">
                                        <label for="bank" class="payment-label">
                                            <span class="payment-icon">🏦</span>
                                            <div class="payment-info">
                                                <span class="payment-title">무통장입금</span>
                                                <span class="payment-desc">입금 확인 후 배송</span>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!-- 포인트 결제 옵션 -->
                                    <div class="payment-option">
                                        <input type="radio" th:field="*{paymentMethod}" value="POINT" id="point" onchange="handlePaymentMethodChange('point')">
                                        <label for="point" class="payment-label">
                                            <span class="payment-icon">💎</span>
                                            <div class="payment-info">
                                                <span class="payment-title">포인트 결제</span>
                                                <!-- 사용자 보유 포인트 동적 표시 -->
                                                <span class="payment-desc" th:text="'보유: ' + ${#numbers.formatInteger(session.user.points, 3, 'COMMA')} + 'P'">보유: 15,680P</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- 신용카드 정보 입력 폼 (기본 숨김) -->
                                <div id="cardDetails" class="payment-details" style="display: none;">
                                    <h4>💳 카드 정보 입력</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="cardNumber">카드번호 *</label>
                                            <input type="text" th:field="*{cardNumber}" id="cardNumber" 
                                                   placeholder="0000-0000-0000-0000" maxlength="19">
                                        </div>
                                        <div class="form-group">
                                            <label for="cardExpiry">유효기간 *</label>
                                            <input type="text" th:field="*{cardExpiry}" id="cardExpiry" 
                                                   placeholder="MM/YY" maxlength="5">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="cardCvc">CVC *</label>
                                            <input type="text" th:field="*{cardCvc}" id="cardCvc" 
                                                   placeholder="000" maxlength="3">
                                        </div>
                                        <div class="form-group">
                                            <label for="cardPassword">카드 비밀번호 앞 2자리 *</label>
                                            <input type="password" th:field="*{cardPassword}" id="cardPassword" 
                                                   placeholder="**" maxlength="2">
                                        </div>
                                    </div>
                                </div>

                                <!-- 무통장입금 정보 입력 폼 (기본 표시) -->
                                <div id="bankDetails" class="payment-details">
                                    <h4>🏦 입금 정보 입력</h4>
                                    <div class="form-group">
                                        <label for="selectedBank">입금 은행 선택 *</label>
                                        <select th:field="*{selectedBank}" id="selectedBank" required>
                                            <option value="">은행을 선택해주세요</option>
                                            <!-- 서버에서 전달받은 은행 목록 출력 -->
                                            <option th:each="bank : ${availableBanks}" 
                                                    th:value="${bank.code}" 
                                                    th:text="${bank.name} + ' (' + ${bank.accountNumber} + ')'">국민은행 (123-45-67890-123)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="depositorName">입금자명 *</label>
                                        <input type="text" th:field="*{depositorName}" id="depositorName" 
                                               th:value="${session.user != null ? session.user.name : ''}"
                                               placeholder="입금자명을 입력해주세요" required>
                                    </div>
                                    <!-- 입금 안내 정보 -->
                                    <div class="bank-info">
                                        <div class="deposit-notice">
                                            <p><strong>📌 입금 안내:</strong></p>
                                            <ul>
                                                <li>입금자명은 주문자명과 동일해야 합니다.</li>
                                                <li>입금 확인 후 배송이 시작됩니다.</li>
                                                <li>3일 이내 입금하지 않으면 주문이 자동 취소됩니다.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- 포인트 결제 정보 입력 폼 (기본 숨김) -->
                                <div id="pointDetails" class="payment-details" style="display: none;">
                                    <h4>💎 포인트 사용</h4>
                                    <!-- 보유 포인트 표시 -->
                                    <div class="point-balance">
                                        <div class="balance-info">
                                            <span class="balance-label">보유 포인트</span>
                                            <span class="balance-amount" th:text="${#numbers.formatInteger(session.user.points, 3, 'COMMA')} + 'P'">15,680P</span>
                                        </div>
                                    </div>
                                    <!-- 사용할 포인트 입력 -->
                                    <div class="form-group">
                                        <label for="usePoints">사용할 포인트 *</label>
                                        <div class="point-input-group">
                                            <input type="number" th:field="*{usePoints}" id="usePoints" 
                                                   placeholder="0" min="0" th:max="${session.user.points}" 
                                                   onchange="calculateRemainingAmount()">
                                            <span class="point-unit">P</span>
                                            <button type="button" class="btn-use-all-points" 
                                                    th:onclick="|useAllPoints(${session.user.points})|">
                                                전액 사용
                                            </button>
                                        </div>
                                        <!-- 포인트 사용 안내 -->
                                        <div class="point-notice">
                                            <p>• 최소 1,000P부터 사용 가능합니다.</p>
                                            <p>• 1P = 1원으로 계산됩니다.</p>
                                        </div>
                                    </div>
                                    <!-- 포인트 사용 후 남은 결제 금액 표시 -->
                                    <div class="remaining-amount" id="remainingAmount">
                                        <div class="amount-row">
                                            <span>포인트 사용</span>
                                            <span id="pointUsage">0P</span>
                                        </div>
                                        <div class="amount-row">
                                            <span>남은 결제금액</span>
                                            <span id="remainingPayment" th:text="${#numbers.formatInteger(orderSummary.total, 3, 'COMMA')} + '원'">47,000원</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 이용약관 동의 섹션 -->
                            <div class="form-section">
                                <h3>📋 주문 동의</h3>
                                <div class="agreement-section">
                                    <!-- 전체 동의 체크박스 -->
                                    <label class="agreement-item">
                                        <input type="checkbox" id="agreeAll" onclick="toggleAllAgreements()">
                                        <span class="checkmark"></span>
                                        <span class="agreement-text">전체 동의</span>
                                    </label>
                                    
                                    <!-- 개별 동의 항목들 -->
                                    <label class="agreement-item">
                                        <input type="checkbox" th:field="*{agreeOrder}" class="agreement-checkbox" required>
                                        <span class="checkmark"></span>
                                        <span class="agreement-text">주문 내용 확인 및 결제 동의 (필수)</span>
                                    </label>
                                    
                                    <label class="agreement-item">
                                        <input type="checkbox" th:field="*{agreePrivacy}" class="agreement-checkbox" required>
                                        <span class="checkmark"></span>
                                        <span class="agreement-text">개인정보 수집 이용 동의 (필수)</span>
                                    </label>
                                    
                                    <label class="agreement-item">
                                        <input type="checkbox" th:field="*{agreeMarketing}" class="agreement-checkbox">
                                        <span class="checkmark"></span>
                                        <span class="agreement-text">마케팅 정보 수신 동의 (선택)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 오른쪽: 주문 요약 정보 -->
                        <div class="order-summary">
                            <!-- 주문 상품 목록 표시 -->
                            <div class="summary-section">
                                <h3>🛒 주문 상품</h3>
                                <div class="order-items" id="orderItems">
                                    <!-- Thymeleaf 반복문으로 주문 상품 출력 -->
                                    <div class="order-item" th:each="item : ${orderItems}">
                                        <div class="item-image">
                                            <img th:src="${item.product.imageUrl != null ? item.product.imageUrl : '/img/default-product.svg'}" 
                                                 th:alt="${item.product.name}">
                                        </div>
                                        <div class="item-info">
                                            <h4 th:text="${item.product.name}">상품명</h4>
                                            <div class="item-details">
                                                <span th:text="'수량: ' + ${item.quantity} + '개'">수량: 2개</span>
                                                <span th:text="${#numbers.formatInteger(item.product.salePrice * item.quantity, 3, 'COMMA')} + '원'">32,000원</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 결제 금액 요약 -->
                            <div class="summary-section">
                                <h3>💰 결제 금액</h3>
                                <div class="price-summary">
                                    <!-- 서버에서 계산된 가격 정보 사용 -->
                                    <div class="price-row">
                                        <span>상품금액</span>
                                        <span id="subtotal" th:text="${#numbers.formatInteger(orderSummary.subtotal, 3, 'COMMA')} + '원'">55,500원</span>
                                    </div>
                                    <div class="price-row discount" th:if="${orderSummary.discount > 0}">
                                        <span>할인금액</span>
                                        <span id="discount" th:text="'-' + ${#numbers.formatInteger(orderSummary.discount, 3, 'COMMA')} + '원'">-8,500원</span>
                                    </div>
                                    <div class="price-row">
                                        <span>배송비</span>
                                        <span id="shipping" th:text="${orderSummary.shippingFee > 0 ? (#numbers.formatInteger(orderSummary.shippingFee, 3, 'COMMA') + '원') : '무료'}">무료</span>
                                    </div>
                                    <!-- 쿠폰 할인이 있을 때만 표시 -->
                                    <div class="price-row coupon-discount" th:if="${orderSummary.couponDiscount > 0}" id="couponDiscountRow">
                                        <span>쿠폰할인</span>
                                        <span id="couponDiscount" th:text="'-' + ${#numbers.formatInteger(orderSummary.couponDiscount, 3, 'COMMA')} + '원'">-0원</span>
                                    </div>
                                    <div class="price-divider"></div>
                                    <div class="price-row total">
                                        <span>최종 결제금액</span>
                                        <span id="finalTotal" th:text="${#numbers.formatInteger(orderSummary.total, 3, 'COMMA')} + '원'">47,000원</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 환경 임팩트 정보 표시 -->
                            <div class="summary-section">
                                <h3>🌍 환경 임팩트</h3>
                                <div class="eco-impact">
                                    <div class="impact-item">
                                        <span>탄소발자국 절약</span>
                                        <span class="impact-value" th:text="${orderSummary.totalCarbonSaved} + 'kg CO₂'">8.8kg CO₂</span>
                                    </div>
                                    <div class="impact-item">
                                        <span>플라스틱 사용 절약</span>
                                        <span class="impact-value" th:text="${orderSummary.plasticSaved} + 'g'">450g</span>
                                    </div>
                                    <div class="impact-item">
                                        <span>적립 예정 포인트</span>
                                        <span class="impact-value" th:text="${orderSummary.expectedPoints} + 'P'">470P</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 최종 결제 버튼 -->
                            <div class="payment-action">
                                <button type="submit" class="btn-payment" id="paymentBtn"
                                        th:text="'💳 ' + ${#numbers.formatInteger(orderSummary.total, 3, 'COMMA')} + '원 결제하기'">
                                    💳 47,000원 결제하기
                                </button>
                                <p class="payment-notice">
                                    결제 시 개인정보보호정책과 이용약관에 동의한 것으로 간주됩니다.
                                </p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <!-- Footer (장바구니와 동일) -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo" style="margin-bottom: 20px;">
                        <span class="logo-icon">🌱</span>
                        <span class="logo-text">GreenCycle</span>
                    </div>
                    <p>첨단 기술로 실현하는 스마트하고 지속 가능한 환경 플랫폼</p>
                </div>
                <div class="footer-section">
                    <h4>서비스</h4>
                    <ul>
                        <li><a th:href="@{/waste-sorting}">스마트 분리배출</a></li>
                        <li><a th:href="@{/free-sharing}">무료나눔</a></li>
                        <li><a th:href="@{/eco-market}">에코마켓</a></li>
                        <li><a th:href="@{/eco-talk}">환경독톡</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>고객지원</h4>
                    <ul>
                        <li><a th:href="@{/contact}">문의하기</a></li>
                        <li><a th:href="@{/guide}">이용가이드</a></li>
                        <li><a th:href="@{/delivery-policy}">배송/교환/환불</a></li>
                        <li><a th:href="@{/customer-service}">고객센터</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>정책</h4>
                    <ul>
                        <li><a th:href="@{/privacy-policy}">개인정보처리방침</a></li>
                        <li><a th:href="@{/terms}">이용약관</a></li>
                        <li><a th:href="@{/eco-policy}">친환경 정책</a></li>
                        <li><a th:href="@{/carbon-neutral}">탄소중립 인증</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 GreenCycle. All rights reserved.</p>
                <div class="footer-links">
                    <a th:href="@{/privacy-policy}">개인정보처리방침</a>
                    <a th:href="@{/terms}">이용약관</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- 결제 처리 중 모달 -->
    <div id="paymentModal" class="payment-modal" style="display: none;">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <h3>결제 처리 중...</h3>
            <p>잠시만 기다려주세요.</p>
        </div>
    </div>

    <!-- JavaScript 파일 연결 - Thymeleaf 정적 리소스 경로 -->
    <script th:src="@{/js/checkout.js}"></script>
    
    <!-- 주문 데이터를 JavaScript로 전달 -->
    <script th:inline="javascript">
        // 서버에서 전달받은 주문 데이터를 JavaScript 변수로 설정
        var orderData = /*[[${orderItems}]]*/ [];
        var orderSummaryData = /*[[${orderSummary}]]*/ {};
        var userPoints = /*[[${session.user.points}]]*/ 0;
        
        // 주문 관련 JavaScript 함수들에서 사용할 수 있도록 전역 변수로 설정
        window.orderData = orderData;
        window.orderSummary = orderSummaryData;
        window.userPoints = userPoints;
    </script>
</body>
</html>