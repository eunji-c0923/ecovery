<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- 페이지 기본 설정 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 동적 페이지 제목 -->
    <title th:text="${sharingItem.title + ' - GreenCycle'}">GreenCycle - 무료나눔 상세보기</title>
    
    <!-- CSS 파일 연결 - Thymeleaf 정적 리소스 경로 -->
    <link rel="stylesheet" th:href="@{/css/free-sharing-detail.css}">
    
    <!-- 구글 폰트 연결 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 상단 헤더 메뉴 -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <!-- 로고 - Thymeleaf URL 처리 -->
                <a th:href="@{/}" class="logo">
                    <img th:src="@{/img/logo.png}" alt="GreenCycle 로고" class="logo-img">
                </a>
                
                <!-- 메뉴 목록 -->
                <ul class="nav-menu">
                    <li><a th:href="@{/}">홈</a></li>
                    <li><a th:href="@{/#services}">서비스</a></li>
                    <li><a th:href="@{/waste-sorting}">분리배출</a></li>
                    <li><a th:href="@{/free-sharing}" class="active">무료나눔</a></li>
                    <li><a th:href="@{/eco-market}">에코마켓</a></li>
                    <li><a th:href="@{/eco-talk}">환경독톡</a></li>
                    <li><a th:href="@{/notices}">공지사항</a></li>
                </ul>
                
                <!-- 로그인/회원가입 버튼 - 로그인 상태에 따른 조건부 표시 -->
                <div class="auth-buttons">
                    <!-- 로그인한 경우 -->
                    <div id="userInfo" th:if="${session.user}" style="display: flex; align-items: center; gap: 10px;">
                        <span class="user-name" th:text="${session.user.nickname}">닉네임</span>
                        <a th:href="@{/logout}" class="btn-logout">로그아웃</a>
                    </div>
                    <!-- 비로그인 상태 -->
                    <div id="loginButtons" th:unless="${session.user}" style="display: flex; gap: 15px;">
                        <a th:href="@{/login}" class="btn-login">로그인</a>
                        <a th:href="@{/signup}" class="btn-signup">회원가입</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- 메인 내용 -->
    <main class="main-content">
        <!-- 현재 위치 표시 (빵부스러기) -->
        <section class="breadcrumb">
            <div class="container">
                <nav class="breadcrumb-nav">
                    <a th:href="@{/}">🏠</a> 
                    <span>></span> 
                    <a th:href="@{/free-sharing}">무료나눔</a> 
                    <span>></span> 
                    <span class="current">상세보기</span>
                </nav>
            </div>
        </section>

        <!-- 상세보기 내용 -->
        <section class="detail-section">
            <div class="container">
                <div class="detail-container">
                    <!-- 상품 이미지 섹션 -->
                    <div class="image-section">
                        <!-- 메인 이미지 -->
                        <div class="main-image">
                            <img th:src="${sharingItem.mainImageUrl != null ? sharingItem.mainImageUrl : '/img/default-sharing.svg'}" 
                                 th:alt="${sharingItem.title}" id="mainImage">
                        </div>
                        <!-- 썸네일 이미지들 - 여러 이미지가 있는 경우만 표시 -->
                        <div class="thumbnail-images" th:if="${sharingItem.images != null and sharingItem.images.size() > 1}">
                            <img th:each="image, iterStat : ${sharingItem.images}" 
                                 th:src="${image.url}" 
                                 th:alt="'썸네일 ' + ${iterStat.count}" 
                                 class="thumbnail" 
                                 th:classappend="${iterStat.first ? 'active' : ''}"
                                 th:onclick="|changeMainImage(this)|">
                        </div>
                    </div>

                    <!-- 상품 정보 섹션 -->
                    <div class="info-section">
                        <!-- 상품 헤더 (제목과 관리 버튼) -->
                        <div class="product-header">
                            <div class="product-title-area">
                                <!-- 상태 배지 -->
                                <div class="status-badge" 
                                     th:text="${sharingItem.status == 'AVAILABLE' ? '나눔중' : (sharingItem.status == 'RESERVED' ? '예약중' : '완료')}">나눔중</div>
                                <!-- 상품 제목 -->
                                <h1 class="product-title" th:text="${sharingItem.title}">MacBook Pro 13인치 (2021) M1 칩</h1>
                            </div>
                            
                            <!-- 관리 버튼 (로그인한 사용자이고 본인 게시글인 경우만 표시) -->
                            <div class="product-actions" id="productActions" 
                                 th:if="${session.user != null and session.user.id == sharingItem.authorId}">
                                <div class="dropdown">
                                    <button class="dropdown-toggle" id="dropdownToggle">
                                        <span class="dots">⋯</span>
                                    </button>
                                    <div class="dropdown-menu" id="dropdownMenu">
                                        <a th:href="@{/free-sharing/edit/{id}(id=${sharingItem.id})}" class="dropdown-item">
                                            <span class="icon">✏️</span>
                                            수정하기
                                        </a>
                                        <a href="#" class="dropdown-item delete" th:onclick="|deletePost(${sharingItem.id})|">
                                            <span class="icon">🗑️</span>
                                            삭제하기
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 작성자 정보 -->
                        <div class="author-info">
                            <div class="author-avatar">
                                <img th:src="${sharingItem.author.profileImageUrl != null ? sharingItem.author.profileImageUrl : '/img/default-avatar.svg'}" 
                                     th:alt="${sharingItem.author.nickname}">
                            </div>
                            <div class="author-details">
                                <div class="author-name" th:text="${sharingItem.author.nickname}">작성자</div>
                                <div class="author-meta">
                                    <span class="view-count" th:text="'👀 ' + ${sharingItem.viewCount}">👀 125</span>
                                    <span class="post-date" th:text="${sharingItem.timeAgo}">15분 전</span>
                                </div>
                            </div>
                        </div>

                        <!-- 상품 상태 -->
                        <div class="product-condition">
                            <h3>상품 상태</h3>
                            <div class="condition-rating">
                                <span class="stars" th:text="${sharingItem.conditionStars}">⭐⭐⭐⭐⭐</span>
                                <span class="condition-text" th:text="${sharingItem.conditionText}">거의 새것</span>
                            </div>
                            <p class="condition-description" th:text="${sharingItem.conditionDescription}">
                                케이스와 보호필름을 항상 사용하여 외관이 매우 깨끗습니다.
                            </p>
                        </div>

                        <!-- 상품 상세 정보 -->
                        <div class="product-details">
                            <div class="detail-row">
                                <span class="detail-label">카테고리</span>
                                <span class="detail-value" th:text="${sharingItem.categoryName}">전자제품</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">거래 지역</span>
                                <span class="detail-value" th:text="'📍 ' + ${sharingItem.location}">📍 강남역 2번 출구</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">거래 방법</span>
                                <span class="detail-value" th:text="${#strings.listJoin(sharingItem.tradeMethods, ', ')}">직거래 우선, 택배 가능</span>
                            </div>
                            <div class="detail-row" th:if="${sharingItem.shippingInfo != null}">
                                <span class="detail-label">배송비</span>
                                <span class="detail-value" th:text="${sharingItem.shippingInfo}">착불 (3,000원)</span>
                            </div>
                        </div>

                        <!-- 연락처 버튼 (로그인한 사용자만, 본인 게시글이 아닌 경우) -->
                        <div class="contact-section" th:if="${session.user != null and session.user.id != sharingItem.authorId}">
                            <button class="contact-btn primary" th:onclick="|showContactInfo(${sharingItem.id})|">
                                📞 연락처 보기
                            </button>
                            <button class="contact-btn secondary" th:onclick="|showChatModal(${sharingItem.id})|">
                                💬 채팅하기
                            </button>
                        </div>

                        <!-- 로그인하지 않은 경우 로그인 유도 -->
                        <div class="login-required" th:unless="${session.user}">
                            <p>연락처를 확인하려면 로그인이 필요합니다.</p>
                            <a th:href="@{/login}" class="btn btn-primary">로그인하기</a>
                        </div>
                    </div>
                </div>

                <!-- 상품 설명 -->
                <div class="description-section">
                    <h2>상품 설명</h2>
                    <!-- 상품 설명 내용 - HTML 태그가 포함될 수 있으므로 utext 사용 -->
                    <div class="description-content" id="productDescription" th:utext="${sharingItem.description}">
                        <!-- 기본 설명 내용 -->
                    </div>
                </div>

                <!-- 관련 상품 추천 -->
                <div class="related-section" th:if="${relatedItems != null and !relatedItems.isEmpty()}">
                    <h2>비슷한 나눔 상품</h2>
                    <div class="related-items">
                        <!-- 관련 상품들 반복문으로 출력 -->
                        <div class="related-item" th:each="relatedItem : ${relatedItems}"
                             th:onclick="|location.href='@{/free-sharing/detail/{id}(id=${relatedItem.id})}'|">
                            <img th:src="${relatedItem.imageUrl != null ? relatedItem.imageUrl : '/img/default-sharing.svg'}" 
                                 th:alt="${relatedItem.title}">
                            <div class="related-info">
                                <h4 th:text="${relatedItem.title}">관련 상품명</h4>
                                <p th:text="${relatedItem.categoryName + ' • ' + relatedItem.location}">태블릿 • 강남구</p>
                                <span class="related-time" th:text="${relatedItem.timeAgo}">1시간 전</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 하단 푸터 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <!-- 회사 정보 -->
                <div class="footer-section">
                    <div class="logo">
                        <span class="logo-icon">🌱</span>
                        <span class="logo-text">GreenCycle</span>
                    </div>
                    <p>첨단 기술로 실현하는 스마트하고 지속 가능한 환경 플랫폼</p>
                </div>
                
                <!-- 서비스 링크 -->
                <div class="footer-section">
                    <h4>서비스</h4>
                    <ul>
                        <li><a th:href="@{/waste-sorting}">스마트 분리배출</a></li>
                        <li><a th:href="@{/free-sharing}">무료나눔</a></li>
                        <li><a th:href="@{/eco-market}">에코마켓</a></li>
                        <li><a th:href="@{/eco-talk}">환경독톡</a></li>
                    </ul>
                </div>
                
                <!-- 회사 정보 링크 -->
                <div class="footer-section">
                    <h4>회사정보</h4>
                    <ul>
                        <li><a th:href="@{/about}">회사소개</a></li>
                        <li><a th:href="@{/careers}">채용정보</a></li>
                    </ul>
                </div>
                
                <!-- 고객 지원 링크 -->
                <div class="footer-section">
                    <h4>고객지원</h4>
                    <ul>
                        <li><a th:href="@{/contact}">문의하기</a></li>
                        <li><a th:href="@{/customer-service}">고객센터</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- 저작권 정보 -->
            <div class="footer-bottom">
                <p>&copy; 2025 GreenCycle. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- 연락처 모달 -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>연락처 정보</h3>
                <button class="modal-close" onclick="closeModal('contactModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="contact-info">
                    <div class="contact-item" th:if="${sharingItem.author.phone}">
                        <span class="contact-label">📞 전화번호</span>
                        <span class="contact-value" th:text="${sharingItem.author.phone}">010-1234-5678</span>
                    </div>
                    <div class="contact-item" th:if="${sharingItem.author.kakaoId}">
                        <span class="contact-label">💌 카카오톡</span>
                        <span class="contact-value" th:text="${sharingItem.author.kakaoId}">greencycle_user</span>
                    </div>
                    <div class="contact-notice">
                        ⚠️ 연락 시 "GreenCycle 무료나눔"이라고 말씀해주세요.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 채팅 모달 -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>채팅하기</h3>
                <button class="modal-close" onclick="closeModal('chatModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- 채팅 메시지들이 여기에 동적으로 추가됨 -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" placeholder="메시지를 입력하세요..." id="chatInput">
                        <button class="chat-send" th:onclick="|sendMessage(${sharingItem.id})|">전송</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 파일 연결 - Thymeleaf 정적 리소스 경로 -->
    <script th:src="@{/js/free-sharing-detail.js}"></script>
    
    <!-- 상품 데이터를 JavaScript로 전달 -->
    <script th:inline="javascript">
        // 서버에서 전달받은 상품 데이터를 JavaScript 변수로 설정
        var sharingItemData = /*[[${sharingItem}]]*/ {};
        var currentUserId = /*[[${session.user != null ? session.user.id : null}]]*/ null;
        var isOwner = /*[[${session.user != null and session.user.id == sharingItem.authorId}]]*/ false;
        
        // 전역 변수로 설정
        window.sharingItemData = sharingItemData;
        window.currentUserId = currentUserId;
        window.isOwner = isOwner;
        
        // 메인 이미지 변경 함수
        function changeMainImage(thumbnail) {
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail');
            
            // 메인 이미지 변경
            mainImage.src = thumbnail.src;
            
            // 활성 썸네일 변경
            thumbnails.forEach(thumb => thumb.classList.remove('active'));
            thumbnail.classList.add('active');
        }
        
        // 연락처 정보 표시 함수
        function showContactInfo(itemId) {
            if (!currentUserId) {
                alert('로그인이 필요합니다.');
                location.href = '/login';
                return;
            }
            
            // 모달 표시
            document.getElementById('contactModal').style.display = 'block';
        }
        
        // 채팅 모달 표시 함수
        function showChatModal(itemId) {
            if (!currentUserId) {
                alert('로그인이 필요합니다.');
                location.href = '/login';
                return;
            }
            
            // 채팅 모달 표시
            document.getElementById('chatModal').style.display = 'block';
            
            // 기존 채팅 메시지 로드
            loadChatMessages(itemId);
        }
        
        // 채팅 메시지 전송 함수
        function sendMessage(itemId) {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // 서버에 메시지 전송
            fetch(`/api/chat/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    itemId: itemId,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 채팅 입력창 초기화
                    chatInput.value = '';
                    // 채팅 메시지 다시 로드
                    loadChatMessages(itemId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('메시지 전송에 실패했습니다.');
            });
        }
        
        // 채팅 메시지 로드 함수
        function loadChatMessages(itemId) {
            fetch(`/api/chat/messages/${itemId}`)
            .then(response => response.json())
            .then(messages => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = message.senderId === currentUserId ? 'message sent' : 'message received';
                    messageDiv.innerHTML = `
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${message.timeAgo}</div>
                    `;
                    chatMessages.appendChild(messageDiv);
                });
                
                // 스크롤을 맨 아래로
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
        
        // 게시글 삭제 함수
        function deletePost(itemId) {
            if (confirm('정말로 삭제하시겠습니까?')) {
                fetch(`/free-sharing/delete/${itemId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('삭제되었습니다.');
                        location.href = '/free-sharing';
                    } else {
                        alert('삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('오류가 발생했습니다.');
                });
            }
        }
        
        // 모달 닫기 함수
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const contactModal = document.getElementById('contactModal');
            const chatModal = document.getElementById('chatModal');
            
            if (event.target === contactModal) {
                contactModal.style.display = 'none';
            }
            if (event.target === chatModal) {
                chatModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>