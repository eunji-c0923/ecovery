<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- 문서 기본 설정 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>공지사항 작성 - GreenCycle 관리자</title>
    
    <!-- 폰트 로드 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 타임리프 CSS 파일 연결 -->
    <link rel="stylesheet" th:href="@{/css/notice-style.css}">
    <link rel="stylesheet" th:href="@{/css/notice-write-style.css}">
    
    <!-- 리치 에디터 (Quill.js) CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.min.css" rel="stylesheet">
</head>
<body>
    <!-- 상단 헤더 및 네비게이션 (기존과 동일) -->
    <header class="header" id="header">
        <nav class="navbar">
            <div class="nav-container">
                <!-- 로고 영역 -->
                <a th:href="@{/}" class="logo">
                    <img th:src="@{/img/logo.png}" alt="ECOVERY 로고" class="logo-img">
                </a>
                
                <!-- 메인 네비게이션 메뉴 -->
                <ul class="nav-menu" id="navMenu">
                    <li><a th:href="@{/}">홈</a></li>
                    <li><a th:href="@{/services}">서비스</a></li>
                    <li><a th:href="@{/waste-sorting}">분리배출</a></li>
                    <li><a th:href="@{/free-sharing}">무료나눔</a></li>
                    <li><a th:href="@{/eco-market}">에코마켓</a></li>
                    <li><a th:href="@{/eco-talk}">환경톡톡</a></li>
                    <li><a th:href="@{/notices}">공지사항</a></li>
                    <li><a th:href="@{/admin}" class="active">관리자</a></li>
                </ul>
                
                <!-- 사용자 정보 - 관리자 전용 -->
                <div class="auth-buttons">
                    <div th:if="${session.user != null}">
                        <span class="user-welcome admin" th:text="${session.user.nickname + '님 (관리자)'}">관리자님</span>
                        <a th:href="@{/admin}" class="btn-admin">관리자 대시보드</a>
                        <a th:href="@{/logout}" class="btn-logout">로그아웃</a>
                    </div>
                </div>
                
                <!-- 모바일 햄버거 메뉴 -->
                <div class="hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- 메인 콘텐츠 영역 -->
    <main class="main-content">
        <div class="container">
            <!-- 페이지 헤더 -->
            <section class="page-header fade-in">
                <div class="page-header-content">
                    <h1>✍️ 공지사항 작성</h1>
                    <p>ECOVERY 사용자들에게 전달할 중요한 소식을 작성하세요</p>
                </div>
            </section>

            <!-- 공지사항 작성 폼 컨테이너 -->
            <div class="write-container fade-in">
                <!-- 작성 폼 메인 영역 -->
                <div class="write-main">
                    <!-- 타임리프 폼 태그 시작 -->
                    <form th:action="@{/admin/notices}" 
                          method="post" 
                          enctype="multipart/form-data" 
                          class="notice-write-form" 
                          id="noticeWriteForm">
                        
                        <!-- CSRF 토큰 (Spring Security 사용 시) -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        
                        <!-- 폼 헤더 -->
                        <div class="form-header">
                            <h2>📝 새 공지사항 작성</h2>
                            <div class="form-actions-top">
                                <!-- 임시저장 버튼 -->
                                <button type="button" class="btn btn-outline" id="saveDraftBtn">
                                    💾 임시저장
                                </button>
                                <!-- 미리보기 버튼 -->
                                <button type="button" class="btn btn-secondary" id="previewBtn">
                                    👁️ 미리보기
                                </button>
                            </div>
                        </div>

                        <!-- 기본 정보 섹션 -->
                        <div class="form-section">
                            <h3>📋 기본 정보</h3>
                            
                            <!-- 제목 입력 -->
                            <div class="form-group">
                                <label for="title" class="form-label required">
                                    📌 제목
                                </label>
                                <input type="text" 
                                       id="title" 
                                       name="title" 
                                       class="form-input" 
                                       placeholder="공지사항 제목을 입력하세요" 
                                       required
                                       maxlength="100"
                                       th:value="${notice?.title}">
                                <div class="char-counter">
                                    <span id="titleCounter">0</span>/100
                                </div>
                            </div>

                            <!-- 카테고리 및 중요도 설정 -->
                            <div class="form-row">
                                <!-- 카테고리 선택 -->
                                <div class="form-group half-width">
                                    <label for="category" class="form-label required">
                                        🏷️ 카테고리
                                    </label>
                                    <select id="category" name="category" class="form-select" required>
                                        <option value="">카테고리를 선택하세요</option>
                                        <option value="important" th:selected="${notice?.category == 'important'}">중요 공지</option>
                                        <option value="service" th:selected="${notice?.category == 'service'}">서비스</option>
                                        <option value="maintenance" th:selected="${notice?.category == 'maintenance'}">점검</option>
                                        <option value="event" th:selected="${notice?.category == 'event'}">이벤트</option>
                                        <option value="update" th:selected="${notice?.category == 'update'}">업데이트</option>
                                        <option value="general" th:selected="${notice?.category == 'general'}">일반</option>
                                    </select>
                                </div>

                                <!-- 중요도 설정 -->
                                <div class="form-group half-width">
                                    <label class="form-label">⚠️ 중요도 설정</label>
                                    <div class="priority-options">
                                        <label class="radio-option">
                                            <input type="radio" 
                                                   name="priority" 
                                                   value="normal" 
                                                   th:checked="${notice?.priority == 'normal' or notice == null}">
                                            <span class="radio-label">일반</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" 
                                                   name="priority" 
                                                   value="important" 
                                                   th:checked="${notice?.priority == 'important'}">
                                            <span class="radio-label important">중요</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" 
                                                   name="priority" 
                                                   value="urgent" 
                                                   th:checked="${notice?.priority == 'urgent'}">
                                            <span class="radio-label urgent">긴급</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 태그 입력 -->
                            <div class="form-group">
                                <label for="tags" class="form-label">
                                    🏷️ 태그 
                                    <span class="form-hint">(쉼표로 구분하여 입력)</span>
                                </label>
                                <input type="text" 
                                       id="tags" 
                                       name="tags" 
                                       class="form-input" 
                                       placeholder="예: 업데이트, 신기능, 중요"
                                       th:value="${notice?.tagsString}">
                                <div class="tag-preview" id="tagPreview">
                                    <!-- 태그 미리보기가 여기에 표시됩니다 -->
                                </div>
                            </div>
                        </div>

                        <!-- 내용 작성 섹션 -->
                        <div class="form-section">
                            <h3>📝 내용 작성</h3>
                            
                            <!-- 리치 에디터 툴바 -->
                            <div class="editor-toolbar">
                                <span class="form-label required">내용</span>
                                <div class="editor-tools">
                                    <span class="editor-hint">📝 리치 에디터를 사용하여 내용을 작성하세요</span>
                                </div>
                            </div>

                            <!-- 리치 에디터 -->
                            <div class="form-group">
                                <div id="editor" class="editor-container">
                                    <!-- Quill 에디터가 여기에 초기화됩니다 -->
                                </div>
                                <!-- 숨겨진 입력 필드 (실제 내용 저장) -->
                                <textarea name="content" 
                                          id="content" 
                                          style="display: none;" 
                                          th:text="${notice?.content}"></textarea>
                            </div>
                        </div>

                        <!-- 첨부파일 섹션 -->
                        <div class="form-section">
                            <h3>📎 첨부파일</h3>
                            
                            <div class="form-group">
                                <label for="attachments" class="form-label">
                                    파일 첨부 
                                    <span class="form-hint">(최대 5개, 각 10MB 이하)</span>
                                </label>
                                
                                <!-- 파일 업로드 영역 -->
                                <div class="file-upload-area" id="fileUploadArea">
                                    <div class="file-upload-placeholder">
                                        <div class="upload-icon">📎</div>
                                        <p>파일을 드래그하거나 클릭하여 선택하세요</p>
                                        <span class="file-types">지원 형식: JPG, PNG, PDF, DOC, XLS (최대 10MB)</span>
                                    </div>
                                    <input type="file" 
                                           id="attachments" 
                                           name="attachments" 
                                           multiple 
                                           accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx"
                                           style="display: none;">
                                </div>
                                
                                <!-- 첨부파일 목록 -->
                                <div class="attachment-list" id="attachmentList">
                                    <!-- 선택된 파일들이 여기에 표시됩니다 -->
                                </div>
                            </div>
                        </div>

                        <!-- 발행 설정 섹션 -->
                        <div class="form-section">
                            <h3>⚙️ 발행 설정</h3>
                            
                            <div class="form-row">
                                <!-- 발행 상태 -->
                                <div class="form-group half-width">
                                    <label class="form-label">📢 발행 상태</label>
                                    <div class="status-options">
                                        <label class="radio-option">
                                            <input type="radio" 
                                                   name="status" 
                                                   value="draft" 
                                                   th:checked="${notice?.status == 'draft' or notice == null}">
                                            <span class="radio-label">임시저장</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" 
                                                   name="status" 
                                                   value="published" 
                                                   th:checked="${notice?.status == 'published'}">
                                            <span class="radio-label">즉시 발행</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" 
                                                   name="status" 
                                                   value="scheduled" 
                                                   th:checked="${notice?.status == 'scheduled'}">
                                            <span class="radio-label">예약 발행</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- 예약 발행 날짜 -->
                                <div class="form-group half-width">
                                    <label for="publishDate" class="form-label">
                                        📅 발행 예정일 
                                        <span class="form-hint">(예약 발행 시)</span>
                                    </label>
                                    <input type="datetime-local" 
                                           id="publishDate" 
                                           name="publishDate" 
                                           class="form-input"
                                           th:value="${notice?.publishDate}">
                                </div>
                            </div>

                            <!-- 알림 설정 -->
                            <div class="form-group">
                                <label class="form-label">🔔 알림 설정</label>
                                <div class="notification-settings">
                                    <label class="checkbox-option">
                                        <input type="checkbox" 
                                               name="sendEmail" 
                                               value="true"
                                               th:checked="${notice?.sendEmail}">
                                        <span class="checkbox-label">📧 이메일 알림 발송</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" 
                                               name="sendPush" 
                                               value="true"
                                               th:checked="${notice?.sendPush}">
                                        <span class="checkbox-label">📱 푸시 알림 발송</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" 
                                               name="pinTop" 
                                               value="true"
                                               th:checked="${notice?.pinTop}">
                                        <span class="checkbox-label">📌 상단 고정</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 폼 하단 액션 버튼들 -->
                        <div class="form-actions">
                            <div class="action-left">
                                <a th:href="@{/admin/notices}" class="btn btn-outline">
                                    ← 목록으로
                                </a>
                            </div>
                            <div class="action-right">
                                <button type="button" class="btn btn-secondary" id="resetBtn">
                                    🔄 초기화
                                </button>
                                <button type="submit" name="action" value="draft" class="btn btn-outline">
                                    💾 임시저장
                                </button>
                                <button type="submit" name="action" value="publish" class="btn btn-primary" id="publishBtn">
                                    📢 발행하기
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- 사이드바 -->
                <div class="write-sidebar fade-in">
                    <!-- 작성 가이드 -->
                    <div class="sidebar-card">
                        <h3>📖 작성 가이드</h3>
                        <div class="guide-content">
                            <div class="guide-item">
                                <strong>📌 제목 작성 팁</strong>
                                <p>명확하고 간결한 제목을 작성하세요. 이모지를 활용하면 더욱 눈에 띕니다.</p>
                            </div>
                            <div class="guide-item">
                                <strong>📝 내용 작성 팁</strong>
                                <p>중요한 내용은 굵게 표시하고, 목록을 활용하여 가독성을 높이세요.</p>
                            </div>
                            <div class="guide-item">
                                <strong>🏷️ 태그 활용</strong>
                                <p>관련 키워드를 태그로 추가하면 검색이 쉬워집니다.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 최근 공지사항 -->
                    <div class="sidebar-card">
                        <h3>📋 최근 작성한 공지</h3>
                        <div class="recent-notices">
                            <!-- 타임리프로 최근 공지사항 목록 렌더링 -->
                            <div th:each="recentNotice : ${recentNotices}" 
                                 class="recent-item" 
                                 th:onclick="|window.open('@{/notices/{id}(id=${recentNotice.id})}', '_blank')|">
                                <div class="recent-title" th:text="${recentNotice.title}">최근 공지사항 제목</div>
                                <div class="recent-meta">
                                    <span th:text="${#temporals.format(recentNotice.createdAt, 'MM.dd')}">날짜</span>
                                    <span th:text="${recentNotice.status == 'published' ? '발행됨' : '임시저장'}">상태</span>
                                </div>
                            </div>
                            
                            <!-- 최근 공지가 없는 경우 -->
                            <div th:if="${#lists.isEmpty(recentNotices)}" class="no-recent">
                                <p>최근 작성한 공지사항이 없습니다.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 통계 정보 -->
                    <div class="sidebar-card">
                        <h3>📊 통계 정보</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-number" th:text="${statistics.totalNotices}">128</span>
                                <span class="stat-label">전체 공지</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" th:text="${statistics.publishedToday}">3</span>
                                <span class="stat-label">오늘 발행</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" th:text="${statistics.draftCount}">7</span>
                                <span class="stat-label">임시저장</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" th:text="${statistics.scheduledCount}">2</span>
                                <span class="stat-label">예약 발행</span>
                            </div>
                        </div>
                    </div>

                    <!-- 빠른 액션 -->
                    <div class="sidebar-card">
                        <h3>⚡ 빠른 액션</h3>
                        <div class="quick-actions">
                            <a th:href="@{/admin/notices}" class="quick-btn">
                                📋 공지 관리
                            </a>
                            <a th:href="@{/admin/notices/templates}" class="quick-btn">
                                📄 템플릿
                            </a>
                            <a th:href="@{/admin/statistics}" class="quick-btn">
                                📈 통계 보기
                            </a>
                            <a th:href="@{/admin/settings}" class="quick-btn">
                                ⚙️ 설정
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 미리보기 모달 -->
    <div class="modal-overlay" id="previewModal" style="display: none;">
        <div class="modal-content preview-modal">
            <div class="modal-header">
                <h3>👁️ 공지사항 미리보기</h3>
                <button class="modal-close" onclick="closePreview()">×</button>
            </div>
            <div class="modal-body">
                <div class="preview-container" id="previewContainer">
                    <!-- 미리보기 내용이 여기에 렌더링됩니다 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePreview()">닫기</button>
                <button class="btn btn-primary" onclick="publishFromPreview()">이대로 발행</button>
            </div>
        </div>
    </div>

    <!-- 푸터 (기존과 동일) -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo" style="margin-bottom: 20px;">
                        <img th:src="@{/img/logo.png}" alt="ECOVERY 로고" class="logo-img">
                    </div>
                    <p>첨단 기술로 실현하는 스마트하고 지속 가능한 환경 플랫폼</p>
                </div>
                <div class="footer-section">
                    <h4>관리자 메뉴</h4>
                    <ul>
                        <li><a th:href="@{/admin/notices}">공지사항 관리</a></li>
                        <li><a th:href="@{/admin/users}">사용자 관리</a></li>
                        <li><a th:href="@{/admin/statistics}">통계 및 분석</a></li>
                        <li><a th:href="@{/admin/settings}">시스템 설정</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>고객지원</h4>
                    <ul>
                        <li><a href="#">문의하기</a></li>
                        <li><a href="#">이용가이드</a></li>
                        <li><a href="#">기술지원</a></li>
                        <li><a href="#">고객센터</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 GreenCycle. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript 파일 연결 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>
    <script th:src="@{/js/notice-write-script.js}"></script>
    
    <!-- 타임리프 인라인 스크립트 -->
    <script th:inline="javascript">
        // 서버에서 전달받은 데이터
        var notice = /*[[${notice}]]*/ null;
        var user = /*[[${session.user}]]*/ null;
        var csrfToken = /*[[${_csrf.token}]]*/ '';
        var csrfHeader = /*[[${_csrf.headerName}]]*/ '';
        
        // API URL 설정
        var saveDraftUrl = /*[[@{/admin/api/notices/draft}]]*/ '/admin/api/notices/draft';
        var uploadUrl = /*[[@{/admin/api/upload}]]*/ '/admin/api/upload';
        var previewUrl = /*[[@{/admin/api/notices/preview}]]*/ '/admin/api/notices/preview';
    </script>
</body>
</html>